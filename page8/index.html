<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="google-site-verification" content="-Dvab_6VGkQMicZl4INhBCLfzJs7AWMwuSpN8CmbjVA" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Andy Fiedler &middot; 
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/fiedler.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-3dkvEK0WLHRJ7/Csr0BZjAWxERc5WH7bdeUya2aXxdU= sha512-+L4yy6FRcDGbXJ9mPG8MT/3UCDzwR9gPeyFNMCtInsol++5m3bk2bXWKdZjvybmohrAsn3Ua5x8gfLnbE1YkOg==" crossorigin="anonymous">

  <!-- Icons -->

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- JS -->
  <script>
    // Picture element HTML5 shiv
    document.createElement( "picture" );
  </script>
  <script async src="/public/js/picturefill.min.js"></script>
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Andy Fiedler
        </a>
      </h1>
      <p class="lead"></p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            
              <a class="sidebar-nav-item" href="/projects/">Projects</a>
            
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

    </nav>

    <div class="sidebar-footer">
      <p>&copy; 2021 <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC</a>.</p>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/02/business-model-canvas-for-social-enterprises">
        Business Model Canvas for Social Enterprises
      </a>
    </h1>

    <span class="post-date">06 Feb 2015</span>

    <p>Business model generation is <em>difficult</em>. Despite the startup renaissance currently going on, the battlefields of the marketplace are littered with seemed-great-at-the-time business ideas that were  not so great once they launched. The Lean Startup idea embraces this, teaching entrepreneurs to iterate quickly to find “product-market fit” before they run out of cash and need to get a job or go back to the coffers of their investors. In the Lean Startup school of thought, business models are sketched out on a Business Model Canvas (BMC) that is one page and can be filled out in half an hour or less. The engineer in me loves this idea. It embraces the Keep It Simple, Stupid ethos that underlies the most elegant engineering solutions.</p>

<p>The real world is not so simple, however. One wrinkle to the Lean Startup model I’ve been working on recently with a client is how to adapt it to a double bottom line business. A double-bottom line business is one where financial profit is not the sole goal of the owners. Talk about making an already difficult process more challenging! To solve this problem, I decided if we’re not going to Keep it Simple, let’s at least not make it too much more complex! I thought, how can I modify the traditional Lean Startup BMC to reflect a social enterprise with as little additional complexity as possible.</p>

<p>In some of the literature on social entrepreneurship and impact investing, there is the concept of a concessionary investment. <a href="http://www.ssireview.org/up_for_debate/article/impact_investing" target="_blank">A concessionary investment is, in effect, a grant</a> because the investor is sacrificing a market-rate return in order to support some kind of social return on his investment. This could be providing a loan at a lower rate of interest, given the business’s credit risk, or it could be providing risk capital (equity) to a business that is far more financially risky that a traditional startup (which are risky enough!).</p>

<p>I like this approach to thinking of impact investing because is puts just one more constraint on a traditional business model: the fact that the business is capitalized by an investor who wants a financial return in addition to some kind of social return. This keeps the engineer in my happy, because as any good engineer knows, if you put too many constraints on a problem you will get no solution! This is how I decided to reflect the added complexity of a double bottom line business in the BMC.</p>

<p>I added two new boxes to the traditional BMC to capture this. The first is <b>social good</b>, which is non-financial value you are creating for your customers or society at large. The second is <b>capitalization</b>, which should describe how your impact investor (which could be yourself, if you are bootstrapping) will measure his social impact.</p>

<p>This canvas worked well for us, so I wanted to share it in case anyone else is working on a similar problem. If you’ve applied Lean Startup methodologies to a social enterprise, or if this was helpful to you, please let me know in the comments.</p>

<p><img src="/generated/wp/uploads/2015/02/Business-Model-Sketch-Social-Enterprise-800-2512125ef.png" srcset="/generated/wp/uploads/2015/02/Business-Model-Sketch-Social-Enterprise-400-2512125ef.png 400w, /generated/wp/uploads/2015/02/Business-Model-Sketch-Social-Enterprise-600-2512125ef.png 600w, /generated/wp/uploads/2015/02/Business-Model-Sketch-Social-Enterprise-800-2512125ef.png 800w, /generated/wp/uploads/2015/02/Business-Model-Sketch-Social-Enterprise-1000-2512125ef.png 1000w" /></p>

<p>You can also access a <a title="Google Drive Version" href="https://docs.google.com/drawings/d/1J6QyXw0Cjz6WdwU7IIA1YtqooPyOH0_FlLY9Vn1_LVc/edit?usp=sharing" target="_blank">version on Google Drive</a> or a <a title="Google Drive Version (Blank)" href="https://docs.google.com/drawings/d/1WG8nuo2RMbyxZ4ggdM0nChBXdZRbSnDgoO0KwpuxLdg/copy" target="_blank">blank version</a> (note: make a copy of the blank version to edit yourself).</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/11/simple-regex-to-match-options-symbology-initiative-tickers">
        Simple Regex to Match Options Symbology Initiative Tickers
      </a>
    </h1>

    <span class="post-date">18 Nov 2014</span>

    <p>This is a simple regular expression to match Options Symbology Initiative (OSI) tickers. It has been tested in C#:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">ticker</span> <span class="p">=</span> <span class="s">"AAPL  131101C00470000"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">OSITicker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Regex</span><span class="p">(</span><span class="s">@"(.{6})(\d{2})(0\d|1[0-2])(0[1-9]|[12]\d|3[01])(C|P)(\d{8})"</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">match</span> <span class="p">=</span> <span class="n">OSITicker</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="n">ticker</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">underlying</span> <span class="p">=</span> <span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="nf">ToString</span><span class="p">().</span><span class="nf">Trim</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">expirationDate</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span>
     <span class="n">Int32</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="nf">ToString</span><span class="p">())</span> <span class="p">+</span> <span class="m">2000</span><span class="p">,</span>
     <span class="n">Int32</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">3</span><span class="p">].</span><span class="nf">ToString</span><span class="p">()),</span>
     <span class="n">Int32</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">4</span><span class="p">].</span><span class="nf">ToString</span><span class="p">()));</span>
<span class="kt">var</span> <span class="n">isPut</span> <span class="p">=</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">5</span><span class="p">].</span><span class="nf">ToString</span><span class="p">()</span> <span class="p">==</span> <span class="s">"P"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">strikePrice</span> <span class="p">=</span> <span class="n">Double</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">6</span><span class="p">].</span><span class="nf">ToString</span><span class="p">())</span> <span class="p">/</span> <span class="m">1000</span><span class="p">;</span>
</code></pre></div></div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/09/using-the-draft-oauth-assertion-grant-with-google">
        Using the Draft OAuth Assertion Grant with Google+
      </a>
    </h1>

    <span class="post-date">10 Sep 2014</span>

    <p>The IETF has been working on a <a href="https://tools.ietf.org/html/draft-ietf-oauth-assertions-17">new OAuth standard for “assertions”</a> which enables OAuth to work with other types of authentication systems. This can be used to allow users to authenticate with your API through Google+ or other third-party identity providers.</p>

<p>For example, let’s say you are developing a single-page Javascript app or a mobile app that uses both Google’s APIs as well as your own APIs. You’d like to have users authenticate with Google to obtain access to Google’s APIs, but then you’d also like your app to authenticate with your server to gain access to some additional resources. You’d like to not reinvent the wheel and use OAuth for your own API. You also implicitly trust Google to verify the user’s identity, so you don’t want the user to need to go through another OAuth flow just to use your API.</p>

<p>Assertion grants allow you to do this in a standards-compliant way. This is a draft standard that was just submitted in July of 2014, but for this simple use-case, it is already fairly usable.</p>
<h2>How Google+ handles sign in for "combination" apps (with both a client and a server)</h2>
<p>Google has <a href="https://developers.google.com/+/web/signin/server-side-flow#step_6_send_the_authorization_code_to_the_server">some great documentation on how to authenticate both a client and a server</a>, which is worth reading if you plan on implementing this. The gist of it is that first the client authenticates with Google through a OAuth popup or redirect. This gives the client both an access token and an access code. The code is then passed to the server to authenticate the backend.</p>

<p>This “passing the code to the backend step” is what OAuth assertion grants enable in a standards-compliant way.</p>
<h2>OAuth Assertion Grants</h2>
<p>The IETF Assertion Grant spec defines a way to define new grant types that are assertions of identity from third parties. An assertion grant looks like this (from the <a href="https://tools.ietf.org/html/draft-ietf-oauth-assertions-17#section-4.1">example in the spec</a>):</p>
<pre class="lang:js decode:true">{
   "grant_type": "urn:ietf:params:oauth:grant-type:saml2-bearer",
   "assertion": "PHNhbWxwOl...[omitted for brevity]...ZT4",
   "scope": ""
}</pre>
<p>Assertions are very similar to <a href="http://tools.ietf.org/html/rfc6749#section-4.3">Resource Owner Password Credential grants</a> in that they are passed as HTTP POSTs directly to the <code>/token</code> endpoint. The “grant_type” for an assertion must be a absolute URI that defines the assertion type, the “assertion” is a Base64-encoded string (using URL-safe encoding) that contains the actual asserrtion, and the “scope” is the same as other OAuth grant types.</p>
<h2>An OAuth Assertion Grant for Google+</h2>
<p>Since Google has not defined an assertion grant format for Google+ identity, I’ve decided to make one up! You can feel free to steal this format for your own apps.</p>
<pre class="lang:js decode:true">{
   "grant_type": "urn:googlepluscode",
   "assertion": "(see below)",
   "scope": "(specific to your app)"
}</pre>
<p>For my Google+ assertion grant, I’ve just chose “urn:googlepluscode” as the URL. This is arbitrary, but Google would need to standardize this so we currently don’t have a better option. For the assertion itself, I use a Base64-encoded, url-safe version of this JSON:</p>
<pre lanng:js="" decode:true="">{
   "code": "(access code provided by the front-end when it authenticates with Google)",
   "google_plus_user_id": "(Google+ user ID)"
}</pre>
<h2>Verifying the Google+ assertion grant</h2>
<p>When the backend receives the Google+ assertion grant, it should do these steps to verify it:</p>
<ol>
	<li>Convert the access code into an access token</li>
	<li>Call the <code>/oauth/tokeninfo</code> endpoint with the access token from the previous step</li>
	<li>In the response from the <code>tokeninfo</code> endpoint, confirm these things:
<ol>
	<li>The <code>user_id</code> matches the <code>google_plus_user_id</code> in the assertion</li>
	<li>The <code>issued_to</code> from the <code>tokeninfo</code> response matches the <code>client_id</code> of your application (both the front-end and back-end share the same <code>client_id</code>.</li>
</ol>
</li>
</ol>
<p>Stay tuned for a future post on how to implement this with Rails and <a href="https://github.com/doorkeeper-gem/doorkeeper">Doorkeeper</a>!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/09/how-secure-is-the-oauth2-resource-owner-password-credential-flow-for-single-page-apps">
        How secure is the OAuth2 "Resource Owner Password Credential" flow for single-page apps?
      </a>
    </h1>

    <span class="post-date">08 Sep 2014</span>

    <p>I’ve been working on a single-page, browser-based app and I was investigating using the OAuth2 “Resource Owner Password Credential” (ROPC) flow to log users in without needing a normal OAuth popup or redirect. The single-page app is written by the same developers as the backend API, so it is more trusted than a third-party application (which should <em>never</em> touch a user’s password). However, since it is a client-side application in Javascript, it was unclear to me how to take steps to make this as secure as possible, so I did some research. In this post, I’ll describe what I found.</p>
<h2>What the OAuth spec says</h2>
<p>The OAuth spec is a dense monster, but is worth digging into since so many sites are using OAuth today. The <a href="http://tools.ietf.org/html/rfc6749#section-4.3" target="_blank">relevant section of the spec</a> says that the ROPC flow can be used when the resource owner (the user) “has a trust relationship with the client, such as the device operating system or a highly privileged application”, which would apply to an application developed by the same developers as the API server. The spec also says that it should only be used when other flows are “not viable”. This isn’t strictly the case for single-page Javascript applications, which can use the <a href="http://tools.ietf.org/html/rfc6749#section-1.3.2" target="_blank">Implicit Grant</a> flow or the <a href="http://tools.ietf.org/html/rfc6749#section-1.3.1" target="_blank">Authorization Code</a> flow. However, for clients “owned” by the same owner as the authorization server, the OAuth popup or redirect can be a poor user experience and may confuse users since they wouldn’t expect to “authorize” an app that they perceive as one and the same as the service itself. So, assuming you trust the client and are willing to consider “bad user experience” as “not viable”, you could use the ROPC flow for a front-end client.</p>

<p>The other issue is that Javascript clients cannot disguise their client credentials because the user may just “view source” to retrieve the credentials. This makes <a href="https://tools.ietf.org/html/draft-ietf-oauth-v2-31#section-10.2" target="_blank">client impersonation</a> possible. It also means the the client is a “public” client for the purposes of the OAuth spec, and client authentication is not possible. The OAuth spec states that when client authentication is not possible, the authorization server SHOULD employ other means to validate the client’s identity.</p>
<h2>How can we "validate the client's identity" as best as possible with Javascript clients?</h2>
<p>First, we need to accept that because that this is a public client under control of the user, we’ll have to accept that it is impossible to completely prevent client impersonation. You always could impersonate a client with cURL or a web scraper, which is something that is out of the control of the API owner. To prevent this, we’d need some kind of trusted computing architecture where we are 100% certain that the client credentials are protected from prying eyes.</p>

<p>Since we can’t completely prevent client impersonation, we need to define what types of impersonation we are trying to prevent. For Javascript clients, I want to prevent two types of impersonation:</p>
<ol>
	<li>Impersonation by another Javascript client running in a standards-compliant browser on a domain other the official client's domain</li>
	<li>Compromised client Javascript or HTML</li>
</ol>
<p>Both types of impersonation are already well-known and have solutions in other Internet standards that we can use for this case.</p>
<h3>Preventing compromised client source code</h3>
<p>For this one, we can simply use SSL for the client’s domain. If the source code has been compromised through a man-in-the-middle attack, the user will see an SSL error in the browser. The OAuth spec already requires that communication to the authorization server’s token and authorization endpoints occur over SSL. It is permitted in the OAuth spec to have a client delivered over HTTP, however.</p>

<p>In order to use the ROPC grant type for Javascript clients, we need to be more strict than the spec and absolutely ensure that the client is delivered over SSL. If the Javascript client is not delivered over SSL, a middleman could tamper with the client’s Javascript to intercept either the resource owner’s credentials or the access token. This makes it impossible for the resource owner to trust the client, which breaks the first chain of trust between the resource owner and the authorization server.</p>
<h3>Preventing impersonation by other Javascript clients</h3>
<p>The other kind of impersonation we’d like to prevent is another Javascript client (on some other domain) using the official client’s credentials to retrieve access tokens. To do this, we can use the browser’s cross-origin security model.</p>
<h4>If your client is on the same origin as your authentication server</h4>
<p>If you are running a client on the same origin as the authentication server, requests to the authentication server will be permitted through “normal” AJAX and I believe that all you will need to do is <em>not</em> permit cross-domain requests (i.e. don’t enable CORS) on your authentication server and the ROPC flow will be unavailable to impersonating clients. Here’s why:</p>
<ul>
	<li>It is possible to submit a form from another domain to kick off the ROPC flow (a POST to your token endpoint), however, it is not possible for Javascript running on that other domain to access the response. This means that the impersonating Javascript may cause your API server to return an access token via a form submission, but it wouldn't be possible for it to read that token. Since we are not using cookie-based authentication, the client needs to parse the token response for it to become authorized.</li>
	<li>It is not possible for a third-party (an intermediate proxy) to intercept the token in this way because the browser will be communicating with your server over SSL (you are using SSL for your authentication server, right!?).</li>
	<li>You need to ensure that potentially-impersonated POSTs to your token endpoint are not in any way destructive. Typically, CSRF attacks (of which this technically is one) lead to a compromise by either setting a cookie that is later used to access a protected resource or cause a POST that takes an abusive action (withdrawing money). You'll need to ensure that a POST to your token endpoint doesn't do either of these things.</li>
</ul>
<h4>If your client is on a different origin from your authentication server</h4>
<p>If you are running your client on “yourdomain.com” and your API server on “api.yourdomain.com”, you will need to implement CORS anyway. In this case, you should leverage CORS to validate the client. Here’s how you can do it:</p>
<ul>
	<li>For every ROPC-enabled client, record in your API server's database the acceptable Javascript origins for that client.</li>
	<li>When an incoming ROPC grant type comes in, require your client to provide a client ID. Look up that client ID in your database and confirm that the CORS "Origin" header matches the expected origin. Browsers do not permit Javascript clients to forge the "Origin" header, making this robust against Javascript client spoofing.</li>
</ul>
<h3>Additional considerations</h3>
<p>Since IE9 and below don’t implement CORS correctly, many sites implement work-arounds such as iframe proxies or Flash-based work-arounds. I haven’t looked into the implications of using these, but they definitely need careful consideration to make sure they are not exploitable.</p>

<p>You absolutely should implement some kind of rate-limiting on your token endpoint to prevent brute-force attacks.</p>

<p>Finally, you should never issue public clients a refresh token (or any long-lived access token). The reason for this is that, depending on your backend architecture, these could be difficult to revoke should you need to revoke access to a specific client. For example, if you are using a <a href="http://jwt.io">JSON Web Token</a> instead of a database record, you would need to blacklist all of them it to revoke them.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/06/tstables-a-long-overdue-replacement-for-tsdb">
        TsTables, a long overdue replacement for TSDB!
      </a>
    </h1>

    <span class="post-date">30 Jun 2014</span>

    <p>I just posted my replacement for my old time series database, <a title="TsTables – Store High Frequency Data with PyTables" href="http://andyfiedler.com/projects/tstables-store-high-frequency-data-with-pytables/">check it out on the project page</a>.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page9">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page7">Newer</a>
    
  
</div>
    </div>

    
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25710888-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </body>
</html>
