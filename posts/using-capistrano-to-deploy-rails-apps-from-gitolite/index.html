<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="description" content="Andy Fiedler&#x27;s Personal Site"/><title>Using Capistrano to deploy Rails apps from Gitolite</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/588d179d14f543de1f7e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/588d179d14f543de1f7e.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-8495f486508069a84016.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" as="script"/><link rel="preload" href="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.aa021d425006d69b9da8.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-2f6c726a4c5d3dfd1e8f.js" as="script"/><link rel="preload" href="/_next/static/chunks/0a3463f7b698f32fd7af40216f1292ceb318b3f7.39ce756e4870b72d4174.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-29dccdc32ec4574aab67.js" as="script"/></head><body><div id="__next"><div id="main"><div class="max-w-screen-md mx-auto px-4"><div class="flex items-center justify-between py-6 lg:py-10"><a href="/" class="flex items-center"><p class="font-body font-bold text-2xl text-primary dark:text-white">Andy Fiedler</p></a><div class="flex items-center lg:hidden"><svg width="24" height="15" xmlns="http://www.w3.org/2000/svg" class="fill-current text-primary dark:text-white"><g fill-rule="evenodd"><rect width="24" height="3" rx="1.5"></rect><rect x="8" y="6" width="16" height="3" rx="1.5"></rect><rect x="4" y="12" width="20" height="3" rx="1.5"></rect></g></svg></div><div class="hidden lg:block"><ul class="flex items-center"><li class="mr-6 relative group mb-1"><div class="absolute left-0 bottom-0 w-full transition-all h-0 group-hover:h-2 group-hover:bg-yellow opacity-75 z-20"></div><a href="/posts" class="font-body font-medium text-lg text-primary dark:text-white group-hover:text-green dark:group-hover:text-secondary px-2 z-30 block relative transition-colors">Posts</a></li><li><i class="bx text-3xl text-primary dark:text-white cursor-pointer"></i></li></ul></div><div class="bg-black bg-opacity-80 fixed inset-0 z-20 flex opacity-0 pointer-events-none transition-opacity lg:hidden "><div class="ml-auto bg-blue-600 w-2/3 md:w-1/3 p-4"><svg viewBox="0 0 20 20" width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-white absolute top-0 right-0 mt-4 mr-4"><path d="M15.898,4.045c-0.271-0.272-0.713-0.272-0.986,0l-4.71,4.711L5.493,4.045c-0.272-0.272-0.714-0.272-0.986,0s-0.272,0.714,0,0.986l4.709,4.711l-4.71,4.711c-0.272,0.271-0.272,0.713,0,0.986c0.136,0.136,0.314,0.203,0.492,0.203c0.179,0,0.357-0.067,0.493-0.203l4.711-4.711l4.71,4.711c0.137,0.136,0.314,0.203,0.494,0.203c0.178,0,0.355-0.067,0.492-0.203c0.273-0.273,0.273-0.715,0-0.986l-4.711-4.711l4.711-4.711C16.172,4.759,16.172,4.317,15.898,4.045z"></path></svg><i class="absolute top-0 right-0 mt-4 mr-4"></i><ul class="flex flex-col mt-8"><li class=""><a href="/posts" class="font-body font-medium text-lg text-white px-2 block mb-3">Posts</a></li></ul></div></div></div></div><div class="max-w-screen-md mx-auto px-4"><div class="pt-16 lg:pt-20"><div class="border-b border-grey-lighter pb-8 sm:pb-12"><h2 class="font-body font-semibold text-primary dark:text-white text-3xl sm:text-4xl md:text-5xl block leading-tight">Using Capistrano to deploy Rails apps from Gitolite</h2><div class="flex items-center pt-5 sm:pt-8"><p class="font-body font-light text-primary dark:text-white pr-2">2012-08-23 17:29:25 -0400</p></div></div><article class="border-b border-grey-lighter py-8 sm:py-12 prose prose dark:prose-dark max-w-none"><p>Here, I'll show you how to deploy a Rails app from a Gitolite repository via Capistrano. In this example, I'm running a Phusion Passenger on NGINX on Ubuntu 10.04. The instructions should be very similar for Ubuntu 12.04.</p>
<p>First, understand what we're doing here. I'm assuming you are using Gitolite for version control (although similar instructions would probably work for Github). We're going to add a read-only deployment key to the Gitolite repository. When you run <code>cap deploy<&#47;code>, Capistrano will log into your production server via SSH (using public key authentication). Then the Capistrano script will instruct the production server to check out the latest version of your app from the Gitolite repository into a directory on the production server. Finally, the Capistrano script will change a symlink to the new version of your app and instruction Phusion Passenger to reload the app into memory on the next hit.</p>
<h2>Setting up your production server<&#47;h2><br />
Create a new user for deployment-related tasks on your production server. Switch to that user.</p>
<pre class="lang:sh">sudo adduser deployuser<br />
sudo su - deployuser<&#47;pre><br />
Now, generate some SSH keys for that user. Run as the deployuser:</p>
<pre class="lang:sh">ssh-keygen -t rsa<&#47;pre><br />
I don't typically enter a password for this keypair. The reason is that this keypair is only used for read-only access to your code repository in Gitolite. If your code is highly sensitive, you might want a password. If you enter one here, you will be prompted for it each time you deploy code.</p>
<p>Now, wherever you have your Gitolite admin repository checked out, open it up and add the public key to your keydir folder. I like to keep my deployment keys in a subfolder called something like "deployment".</p>
<p>Say, for example, your Gitolite admin repository is at <code>~&#47;repos&#47;gitolite-admin<&#47;code>. Switch to that path. Now enter the folder <code>keydir<&#47;code>. Make a new subfolder called <code>deployment<&#47;code>, and then a new file in that folder called something like <code>MyDeploymentKey.pub<&#47;code>. Open that file in your editor and paste the public key that you just created from your deployment server. Typically, that key is found at <code>~&#47;.ssh&#47;id_rsa.pub<&#47;code>.</p>
<p>Now, open your <code>gitolite.conf<&#47;code> file (in the <code>conf<&#47;code> folder in your Gitolite repository). Find your project and add a directive to grant your deployment key read-only access. Here's an example project section:</p>
<pre class="lang:default highlight:0 decode:true crayon-selected">repo     my-project<br />
         RW = JoeCoder<br />
         R = MyDeploymentKey<&#47;pre><br />
Note that even though the deployment key could be in a subfolder, you still just enter the filename minus the ".pub".</p>
<p>Save the Gitolite files, commit and push to your Gitolite server.</p>
<h2>Setting up Capistrano<&#47;h2><br />
Now, open up your Rails project you want to deploy. Add these gems:</p>
<pre class="lang:ruby"># Gems for deployment<br />
group :development do<br />
  gem "capistrano"<br />
  gem 'rvm-capistrano'<br />
end<&#47;pre><br />
Run <code>bundle install<&#47;code> and then from the top directory of your project, run <code>capify .<&#47;code>. This adds Capistrano to your project. Open up <code>config&#47;deploy.rd<&#47;code> and add something like this:</p>
<pre class="lang:ruby">require "bundler&#47;capistrano"<br />
require "rvm&#47;capistrano"</p>
<p>set :application,   "myapp"<br />
set :domain,        "mydomain.com"<br />
set :repository,    "git@mygitoliteserver.com:mygitrepo"<br />
set :use_sudo,      false<br />
set :deploy_to,     "&#47;srv&#47;mydomain.com&#47;public&#47;#{application}"<br />
set :scm,           "git"<br />
set :user,          "deployuser"</p>
<p>role :app, domain<br />
role :web, domain<br />
role :db, domain, :primary => true</p>
<p># Add RVM's lib directory to the load path.<br />
set :rvm_ruby_string, 'ruby-1.9.3-p358'<br />
set :rvm_type, :system</p>
<p>namespace :deploy do<br />
  task :start, :roles => :app do<br />
    run "touch #{current_release}&#47;tmp&#47;restart.txt"<br />
  end</p>
<p>  task :stop, :roles => :app do<br />
    # Do nothing.<br />
  end</p>
<p>  desc "Restart Application"<br />
  task :restart, :roles => :app do<br />
    run "touch #{current_release}&#47;tmp&#47;restart.txt"<br />
  end</p>
<p>end<&#47;pre><br />
This deploy script will checkout your code from the project myproject on mygitoliteserver.com and deploy it to <code>&#47;srv&#47;mydomain.com&#47;public<&#47;code> on your production server (make sure you create this directory). Whenever you deploy, Capistrano will touch <code>tmp&#47;restart.txt<&#47;code> so that Phusion Passenger restarts with the new code.</p>
<p>Once you are finished editing this script, commit your changes, push your latest code to your Gitolite server.</p>
<h2>Deciding who gets to deploy<&#47;h2><br />
For each user you want to allow to deploy code, have them generate a SSH key. On your deployment server, open or create <code>~deployuser&#47;.ssh&#47;authorized_keys<&#47;code>. For each user you want to allow to deploy, add their public key (one key per line) to this file.</p>
<h2>Deploying!<&#47;h2><br />
Now, to test out deployment, run from your Rails root on your development machine (the machine that has the SSH key you added to <code>~deployuser&#47;.ssh&#47;authorized_keys<&#47;code>), run <code>cap deploy<&#47;code>.</p>
</article></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"using-capistrano-to-deploy-rails-apps-from-gitolite","contentHtml":"\u003cp\u003eHere, I'll show you how to deploy a Rails app from a Gitolite repository via Capistrano. In this example, I'm running a Phusion Passenger on NGINX on Ubuntu 10.04. The instructions should be very similar for Ubuntu 12.04.\u003c/p\u003e\n\u003cp\u003eFirst, understand what we're doing here. I'm assuming you are using Gitolite for version control (although similar instructions would probably work for Github). We're going to add a read-only deployment key to the Gitolite repository. When you run \u003ccode\u003ecap deploy\u003c\u0026#47;code\u003e, Capistrano will log into your production server via SSH (using public key authentication). Then the Capistrano script will instruct the production server to check out the latest version of your app from the Gitolite repository into a directory on the production server. Finally, the Capistrano script will change a symlink to the new version of your app and instruction Phusion Passenger to reload the app into memory on the next hit.\u003c/p\u003e\n\u003ch2\u003eSetting up your production server\u003c\u0026#47;h2\u003e\u003cbr /\u003e\nCreate a new user for deployment-related tasks on your production server. Switch to that user.\u003c/p\u003e\n\u003cpre class=\"lang:sh\"\u003esudo adduser deployuser\u003cbr /\u003e\nsudo su - deployuser\u003c\u0026#47;pre\u003e\u003cbr /\u003e\nNow, generate some SSH keys for that user. Run as the deployuser:\u003c/p\u003e\n\u003cpre class=\"lang:sh\"\u003essh-keygen -t rsa\u003c\u0026#47;pre\u003e\u003cbr /\u003e\nI don't typically enter a password for this keypair. The reason is that this keypair is only used for read-only access to your code repository in Gitolite. If your code is highly sensitive, you might want a password. If you enter one here, you will be prompted for it each time you deploy code.\u003c/p\u003e\n\u003cp\u003eNow, wherever you have your Gitolite admin repository checked out, open it up and add the public key to your keydir folder. I like to keep my deployment keys in a subfolder called something like \"deployment\".\u003c/p\u003e\n\u003cp\u003eSay, for example, your Gitolite admin repository is at \u003ccode\u003e~\u0026#47;repos\u0026#47;gitolite-admin\u003c\u0026#47;code\u003e. Switch to that path. Now enter the folder \u003ccode\u003ekeydir\u003c\u0026#47;code\u003e. Make a new subfolder called \u003ccode\u003edeployment\u003c\u0026#47;code\u003e, and then a new file in that folder called something like \u003ccode\u003eMyDeploymentKey.pub\u003c\u0026#47;code\u003e. Open that file in your editor and paste the public key that you just created from your deployment server. Typically, that key is found at \u003ccode\u003e~\u0026#47;.ssh\u0026#47;id_rsa.pub\u003c\u0026#47;code\u003e.\u003c/p\u003e\n\u003cp\u003eNow, open your \u003ccode\u003egitolite.conf\u003c\u0026#47;code\u003e file (in the \u003ccode\u003econf\u003c\u0026#47;code\u003e folder in your Gitolite repository). Find your project and add a directive to grant your deployment key read-only access. Here's an example project section:\u003c/p\u003e\n\u003cpre class=\"lang:default highlight:0 decode:true crayon-selected\"\u003erepo     my-project\u003cbr /\u003e\n         RW = JoeCoder\u003cbr /\u003e\n         R = MyDeploymentKey\u003c\u0026#47;pre\u003e\u003cbr /\u003e\nNote that even though the deployment key could be in a subfolder, you still just enter the filename minus the \".pub\".\u003c/p\u003e\n\u003cp\u003eSave the Gitolite files, commit and push to your Gitolite server.\u003c/p\u003e\n\u003ch2\u003eSetting up Capistrano\u003c\u0026#47;h2\u003e\u003cbr /\u003e\nNow, open up your Rails project you want to deploy. Add these gems:\u003c/p\u003e\n\u003cpre class=\"lang:ruby\"\u003e# Gems for deployment\u003cbr /\u003e\ngroup :development do\u003cbr /\u003e\n  gem \"capistrano\"\u003cbr /\u003e\n  gem 'rvm-capistrano'\u003cbr /\u003e\nend\u003c\u0026#47;pre\u003e\u003cbr /\u003e\nRun \u003ccode\u003ebundle install\u003c\u0026#47;code\u003e and then from the top directory of your project, run \u003ccode\u003ecapify .\u003c\u0026#47;code\u003e. This adds Capistrano to your project. Open up \u003ccode\u003econfig\u0026#47;deploy.rd\u003c\u0026#47;code\u003e and add something like this:\u003c/p\u003e\n\u003cpre class=\"lang:ruby\"\u003erequire \"bundler\u0026#47;capistrano\"\u003cbr /\u003e\nrequire \"rvm\u0026#47;capistrano\"\u003c/p\u003e\n\u003cp\u003eset :application,   \"myapp\"\u003cbr /\u003e\nset :domain,        \"mydomain.com\"\u003cbr /\u003e\nset :repository,    \"git@mygitoliteserver.com:mygitrepo\"\u003cbr /\u003e\nset :use_sudo,      false\u003cbr /\u003e\nset :deploy_to,     \"\u0026#47;srv\u0026#47;mydomain.com\u0026#47;public\u0026#47;#{application}\"\u003cbr /\u003e\nset :scm,           \"git\"\u003cbr /\u003e\nset :user,          \"deployuser\"\u003c/p\u003e\n\u003cp\u003erole :app, domain\u003cbr /\u003e\nrole :web, domain\u003cbr /\u003e\nrole :db, domain, :primary =\u003e true\u003c/p\u003e\n\u003cp\u003e# Add RVM's lib directory to the load path.\u003cbr /\u003e\nset :rvm_ruby_string, 'ruby-1.9.3-p358'\u003cbr /\u003e\nset :rvm_type, :system\u003c/p\u003e\n\u003cp\u003enamespace :deploy do\u003cbr /\u003e\n  task :start, :roles =\u003e :app do\u003cbr /\u003e\n    run \"touch #{current_release}\u0026#47;tmp\u0026#47;restart.txt\"\u003cbr /\u003e\n  end\u003c/p\u003e\n\u003cp\u003e  task :stop, :roles =\u003e :app do\u003cbr /\u003e\n    # Do nothing.\u003cbr /\u003e\n  end\u003c/p\u003e\n\u003cp\u003e  desc \"Restart Application\"\u003cbr /\u003e\n  task :restart, :roles =\u003e :app do\u003cbr /\u003e\n    run \"touch #{current_release}\u0026#47;tmp\u0026#47;restart.txt\"\u003cbr /\u003e\n  end\u003c/p\u003e\n\u003cp\u003eend\u003c\u0026#47;pre\u003e\u003cbr /\u003e\nThis deploy script will checkout your code from the project myproject on mygitoliteserver.com and deploy it to \u003ccode\u003e\u0026#47;srv\u0026#47;mydomain.com\u0026#47;public\u003c\u0026#47;code\u003e on your production server (make sure you create this directory). Whenever you deploy, Capistrano will touch \u003ccode\u003etmp\u0026#47;restart.txt\u003c\u0026#47;code\u003e so that Phusion Passenger restarts with the new code.\u003c/p\u003e\n\u003cp\u003eOnce you are finished editing this script, commit your changes, push your latest code to your Gitolite server.\u003c/p\u003e\n\u003ch2\u003eDeciding who gets to deploy\u003c\u0026#47;h2\u003e\u003cbr /\u003e\nFor each user you want to allow to deploy code, have them generate a SSH key. On your deployment server, open or create \u003ccode\u003e~deployuser\u0026#47;.ssh\u0026#47;authorized_keys\u003c\u0026#47;code\u003e. For each user you want to allow to deploy, add their public key (one key per line) to this file.\u003c/p\u003e\n\u003ch2\u003eDeploying!\u003c\u0026#47;h2\u003e\u003cbr /\u003e\nNow, to test out deployment, run from your Rails root on your development machine (the machine that has the SSH key you added to \u003ccode\u003e~deployuser\u0026#47;.ssh\u0026#47;authorized_keys\u003c\u0026#47;code\u003e), run \u003ccode\u003ecap deploy\u003c\u0026#47;code\u003e.\u003c/p\u003e\n","layout":"post","status":"publish","published":true,"title":"Using Capistrano to deploy Rails apps from Gitolite","author":{"display_name":"afiedler","login":"afiedler","email":"andy@andyfiedler.com","url":""},"author_login":"afiedler","author_email":"andy@andyfiedler.com","wordpress_id":150,"wordpress_url":"http://andyfiedler.com/?p=150","date":"2012-08-23 17:29:25 -0400","date_gmt":"2012-08-23 21:29:25 -0400","categories":["Tech Notes"],"tags":[]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"using-capistrano-to-deploy-rails-apps-from-gitolite"},"buildId":"ECKqL40zNVKWw6Vnv9zpb","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-144e5fa6fafab6397d9c.js"></script><script src="/_next/static/chunks/main-8495f486508069a84016.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" async=""></script><script src="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.aa021d425006d69b9da8.js" async=""></script><script src="/_next/static/chunks/pages/_app-2f6c726a4c5d3dfd1e8f.js" async=""></script><script src="/_next/static/chunks/0a3463f7b698f32fd7af40216f1292ceb318b3f7.39ce756e4870b72d4174.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-29dccdc32ec4574aab67.js" async=""></script><script src="/_next/static/ECKqL40zNVKWw6Vnv9zpb/_buildManifest.js" async=""></script><script src="/_next/static/ECKqL40zNVKWw6Vnv9zpb/_ssgManifest.js" async=""></script></body></html>