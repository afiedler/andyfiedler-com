<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="description" content="Andy Fiedler&#x27;s Personal Site"/><title>Writing Zero-Downtime Migrations for Rails and Postgres</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/2ebc4650f8bf19a5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/2ebc4650f8bf19a5.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-0d72f87c7081bf6b.js" defer=""></script><script src="/_next/static/chunks/main-c1f318e46964e3b2.js" defer=""></script><script src="/_next/static/chunks/pages/_app-a8fa0b8d60e9233f.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-5774d63731fac027.js" defer=""></script><script src="/_next/static/J6OzeYXX0Nm8MlHPylglN/_buildManifest.js" defer=""></script><script src="/_next/static/J6OzeYXX0Nm8MlHPylglN/_ssgManifest.js" defer=""></script><script src="/_next/static/J6OzeYXX0Nm8MlHPylglN/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div id="main"><div class="max-w-screen-md mx-auto px-4"><div class="flex items-center justify-between py-6 lg:py-10"><a href="/" class="flex items-center"><p class="font-body font-bold text-2xl text-primary dark:text-white">Andy Fiedler</p></a><div class="flex items-center lg:hidden"><svg width="24" height="15" xmlns="http://www.w3.org/2000/svg" class="fill-current text-primary dark:text-white"><g fill-rule="evenodd"><rect width="24" height="3" rx="1.5"></rect><rect x="8" y="6" width="16" height="3" rx="1.5"></rect><rect x="4" y="12" width="20" height="3" rx="1.5"></rect></g></svg></div><div class="hidden lg:block"><ul class="flex items-center"><li class="mr-6 relative group mb-1"><div class="absolute left-0 bottom-0 w-full transition-all h-0 group-hover:h-2 group-hover:bg-yellow opacity-75 z-20"></div><a href="/posts" class="font-body font-medium text-lg text-primary dark:text-white group-hover:text-green dark:group-hover:text-secondary px-2 z-30 block relative transition-colors">Posts</a></li><li><i class="bx text-3xl text-primary dark:text-white cursor-pointer"></i></li></ul></div><div class="bg-black bg-opacity-80 fixed inset-0 z-20 flex opacity-0 pointer-events-none transition-opacity lg:hidden "><div class="ml-auto bg-blue-600 w-2/3 md:w-1/3 p-4"><svg viewBox="0 0 20 20" width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-white absolute top-0 right-0 mt-4 mr-4"><path d="M15.898,4.045c-0.271-0.272-0.713-0.272-0.986,0l-4.71,4.711L5.493,4.045c-0.272-0.272-0.714-0.272-0.986,0s-0.272,0.714,0,0.986l4.709,4.711l-4.71,4.711c-0.272,0.271-0.272,0.713,0,0.986c0.136,0.136,0.314,0.203,0.492,0.203c0.179,0,0.357-0.067,0.493-0.203l4.711-4.711l4.71,4.711c0.137,0.136,0.314,0.203,0.494,0.203c0.178,0,0.355-0.067,0.492-0.203c0.273-0.273,0.273-0.715,0-0.986l-4.711-4.711l4.711-4.711C16.172,4.759,16.172,4.317,15.898,4.045z"></path></svg><i class="absolute top-0 right-0 mt-4 mr-4"></i><ul class="flex flex-col mt-8"><li class=""><a href="/posts" class="font-body font-medium text-lg text-white px-2 block mb-3">Posts</a></li></ul></div></div></div></div><div class="max-w-screen-md mx-auto px-4"><div class="pt-16 lg:pt-20"><div class="border-b border-grey-lighter pb-8 sm:pb-12"><h2 class="font-body font-semibold text-primary dark:text-white text-3xl sm:text-4xl md:text-5xl block leading-tight">Writing Zero-Downtime Migrations for Rails and Postgres</h2><div class="flex items-center pt-5 sm:pt-8"><p class="font-body font-light text-primary dark:text-white pr-2">2014-04-18 09:38:26 -0400</p></div></div><article class="border-b border-grey-lighter py-8 sm:py-12 prose prose dark:prose-dark max-w-none"><p>Let's suppose you are building an app. It is under heavy development and the dev team is cranking out new features left and right. Developers need to continually change the database schema, but you don't want to take down the app for database migrations if at all possible. How the heck do you do this with Rails?</p>
<p>We had this problem recently, and have come up with a procedure that solves it for most small database migrations. The goals of this procedure are to:</p>
<p>Finally, once the production database has been migrated, you should merge your pull request from step 6. This eliminates the dead code supporting the unmigrated version of the database. You should write the code for step 6 at the same time you write the rest of this code. Then just leave the pull request open until you are ready to merge. The advantage of this is that you will be "cleaning up" the extraneous code while it is still fresh in your mind.</p>
<p>Suppose you are dropping a column called "deleted". Prior to dropping the column, you have a default scope that excludes deleted rows. After dropping the column, you want the default scope to include all rows.</p>
<p>You would code a migration to do that like this:</p>
<div><pre><code><span>class</span> <span>DropDeletedFromPosts</span> <span>&#x3C;</span> <span>ActiveRecord</span><span>:</span><span>:</span><span>Migration</span>
   <span>def</span> <span><span>up</span></span>
     drop_column <span>:posts</span><span>,</span> <span>:deleted</span>
   <span>end</span>

   <span>def</span> <span><span>down</span></span>
      add_column <span>:posts</span><span>,</span> <span>:boolean</span><span>,</span> <span>:deleted</span><span>,</span> default<span>:</span> <span>false</span><span>,</span> null<span>:</span> <span>false</span>
   <span>end</span>
<span>end</span>
</code></pre></div>
<p>Then, in your Post model, you'd add branching like this:</p>
<div><pre><code><span>class</span> <span>Post</span> <span>&#x3C;</span> <span>ActiveRecord</span><span>:</span><span>:</span><span>Base</span>

   <span># TODO: Remove this code after the DropDeletedFromPosts migration has</span>
   <span># been applied.</span>
   <span>if</span> <span>Post</span><span>.</span>attribute_names<span>.</span><span>include</span><span>?</span> <span>'deleted'</span>
      default_scope <span>-</span><span>></span> <span>{</span> where<span>(</span>deleted<span>:</span> <span>false</span><span>)</span> <span>}</span>
   <span>end</span>

   <span># Other model code here ...</span>

<span>end</span>
</code></pre></div>
<p>Writing zero-downtime migrations is not easy, and you'll need to do a cost-benefit analysis between scheduling downtime and writing lots of hairy branching code to support a zero-downtime deploy. That decision will depend on how downtime impacts your customers and your development schedule.</p>
<p>Hopefully, if you decide to go the zero-downtime route, this procedure will make your life easier!</p>
</article></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"writing-zero-downtime-migrations-for-rails-and-postgres","contentHtml":"\u003cp\u003eLet's suppose you are building an app. It is under heavy development and the dev team is cranking out new features left and right. Developers need to continually change the database schema, but you don't want to take down the app for database migrations if at all possible. How the heck do you do this with Rails?\u003c/p\u003e\n\u003cp\u003eWe had this problem recently, and have come up with a procedure that solves it for most small database migrations. The goals of this procedure are to:\u003c/p\u003e\n\u003cp\u003eFinally, once the production database has been migrated, you should merge your pull request from step 6. This eliminates the dead code supporting the unmigrated version of the database. You should write the code for step 6 at the same time you write the rest of this code. Then just leave the pull request open until you are ready to merge. The advantage of this is that you will be \"cleaning up\" the extraneous code while it is still fresh in your mind.\u003c/p\u003e\n\u003cp\u003eSuppose you are dropping a column called \"deleted\". Prior to dropping the column, you have a default scope that excludes deleted rows. After dropping the column, you want the default scope to include all rows.\u003c/p\u003e\n\u003cp\u003eYou would code a migration to do that like this:\u003c/p\u003e\n\u003cdiv\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan\u003eclass\u003c/span\u003e \u003cspan\u003eDropDeletedFromPosts\u003c/span\u003e \u003cspan\u003e\u0026#x3C;\u003c/span\u003e \u003cspan\u003eActiveRecord\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003eMigration\u003c/span\u003e\n   \u003cspan\u003edef\u003c/span\u003e \u003cspan\u003e\u003cspan\u003eup\u003c/span\u003e\u003c/span\u003e\n     drop_column \u003cspan\u003e:posts\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e \u003cspan\u003e:deleted\u003c/span\u003e\n   \u003cspan\u003eend\u003c/span\u003e\n\n   \u003cspan\u003edef\u003c/span\u003e \u003cspan\u003e\u003cspan\u003edown\u003c/span\u003e\u003c/span\u003e\n      add_column \u003cspan\u003e:posts\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e \u003cspan\u003e:boolean\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e \u003cspan\u003e:deleted\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e default\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003efalse\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e null\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003efalse\u003c/span\u003e\n   \u003cspan\u003eend\u003c/span\u003e\n\u003cspan\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThen, in your Post model, you'd add branching like this:\u003c/p\u003e\n\u003cdiv\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan\u003eclass\u003c/span\u003e \u003cspan\u003ePost\u003c/span\u003e \u003cspan\u003e\u0026#x3C;\u003c/span\u003e \u003cspan\u003eActiveRecord\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e\u003cspan\u003eBase\u003c/span\u003e\n\n   \u003cspan\u003e# TODO: Remove this code after the DropDeletedFromPosts migration has\u003c/span\u003e\n   \u003cspan\u003e# been applied.\u003c/span\u003e\n   \u003cspan\u003eif\u003c/span\u003e \u003cspan\u003ePost\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003eattribute_names\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003einclude\u003c/span\u003e\u003cspan\u003e?\u003c/span\u003e \u003cspan\u003e'deleted'\u003c/span\u003e\n      default_scope \u003cspan\u003e-\u003c/span\u003e\u003cspan\u003e\u003e\u003c/span\u003e \u003cspan\u003e{\u003c/span\u003e where\u003cspan\u003e(\u003c/span\u003edeleted\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003efalse\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e \u003cspan\u003e}\u003c/span\u003e\n   \u003cspan\u003eend\u003c/span\u003e\n\n   \u003cspan\u003e# Other model code here ...\u003c/span\u003e\n\n\u003cspan\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWriting zero-downtime migrations is not easy, and you'll need to do a cost-benefit analysis between scheduling downtime and writing lots of hairy branching code to support a zero-downtime deploy. That decision will depend on how downtime impacts your customers and your development schedule.\u003c/p\u003e\n\u003cp\u003eHopefully, if you decide to go the zero-downtime route, this procedure will make your life easier!\u003c/p\u003e\n","layout":"post","status":"publish","published":true,"title":"Writing Zero-Downtime Migrations for Rails and Postgres","author":{"display_name":"afiedler","login":"afiedler","email":"andy@andyfiedler.com","url":""},"author_login":"afiedler","author_email":"andy@andyfiedler.com","wordpress_id":265,"wordpress_url":"http://andyfiedler.com/?p=265","date":"2014-04-18 09:38:26 -0400","date_gmt":"2014-04-18 13:38:26 -0400","categories":["Tech Notes"],"tags":["postgres","rails"],"redirect_from":["/blog/writing-zero-downtime-migrations-for-rails-and-postgres-265/","/blog/writing-zero-downtime-migrations-for-rails-and-postgres-265"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"writing-zero-downtime-migrations-for-rails-and-postgres"},"buildId":"J6OzeYXX0Nm8MlHPylglN","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>