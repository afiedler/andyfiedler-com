<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="description" content="Andy Fiedler&#x27;s Personal Site"/><title>Using Node datapipes to ETL from one MongoDB collection to a second MongoDB collection</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/3a91f8daa0490311.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3a91f8daa0490311.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-0d72f87c7081bf6b.js" defer=""></script><script src="/_next/static/chunks/main-c1f318e46964e3b2.js" defer=""></script><script src="/_next/static/chunks/pages/_app-a8fa0b8d60e9233f.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-5774d63731fac027.js" defer=""></script><script src="/_next/static/vPhthCAbGqbPT7mTS8USv/_buildManifest.js" defer=""></script><script src="/_next/static/vPhthCAbGqbPT7mTS8USv/_ssgManifest.js" defer=""></script><script src="/_next/static/vPhthCAbGqbPT7mTS8USv/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div id="main"><div class="max-w-screen-md mx-auto px-4"><div class="flex items-center justify-between py-6 lg:py-10"><a href="/" class="flex items-center"><p class="font-body font-bold text-2xl text-primary dark:text-white">Andy Fiedler</p></a><div class="flex items-center lg:hidden"><svg width="24" height="15" xmlns="http://www.w3.org/2000/svg" class="fill-current text-primary dark:text-white"><g fill-rule="evenodd"><rect width="24" height="3" rx="1.5"></rect><rect x="8" y="6" width="16" height="3" rx="1.5"></rect><rect x="4" y="12" width="20" height="3" rx="1.5"></rect></g></svg></div><div class="hidden lg:block"><ul class="flex items-center"><li class="mr-6 relative group mb-1"><div class="absolute left-0 bottom-0 w-full transition-all h-0 group-hover:h-2 group-hover:bg-yellow opacity-75 z-20"></div><a href="/posts" class="font-body font-medium text-lg text-primary dark:text-white group-hover:text-green dark:group-hover:text-secondary px-2 z-30 block relative transition-colors">Posts</a></li><li><i class="bx text-3xl text-primary dark:text-white cursor-pointer"></i></li></ul></div><div class="bg-black bg-opacity-80 fixed inset-0 z-20 flex opacity-0 pointer-events-none transition-opacity lg:hidden "><div class="ml-auto bg-blue-600 w-2/3 md:w-1/3 p-4"><svg viewBox="0 0 20 20" width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-white absolute top-0 right-0 mt-4 mr-4"><path d="M15.898,4.045c-0.271-0.272-0.713-0.272-0.986,0l-4.71,4.711L5.493,4.045c-0.272-0.272-0.714-0.272-0.986,0s-0.272,0.714,0,0.986l4.709,4.711l-4.71,4.711c-0.272,0.271-0.272,0.713,0,0.986c0.136,0.136,0.314,0.203,0.492,0.203c0.179,0,0.357-0.067,0.493-0.203l4.711-4.711l4.71,4.711c0.137,0.136,0.314,0.203,0.494,0.203c0.178,0,0.355-0.067,0.492-0.203c0.273-0.273,0.273-0.715,0-0.986l-4.711-4.711l4.711-4.711C16.172,4.759,16.172,4.317,15.898,4.045z"></path></svg><i class="absolute top-0 right-0 mt-4 mr-4"></i><ul class="flex flex-col mt-8"><li class=""><a href="/posts" class="font-body font-medium text-lg text-white px-2 block mb-3">Posts</a></li></ul></div></div></div></div><div class="max-w-screen-md mx-auto px-4"><div class="pt-16 lg:pt-20"><div class="border-b border-grey-lighter pb-8 sm:pb-12"><h2 class="font-body font-semibold text-primary dark:text-white text-3xl sm:text-4xl md:text-5xl block leading-tight">Using Node datapipes to ETL from one MongoDB collection to a second MongoDB collection</h2><div class="flex items-center pt-5 sm:pt-8"><p class="font-body font-light text-primary dark:text-white pr-2">2015-07-15 16:14:01 -0400</p></div></div><article class="border-b border-grey-lighter py-8 sm:py-12 prose prose dark:prose-dark max-w-none"><p>ETL - not the most fun to write, but the datapipes package makes it pretty easy on NodeJS.</p>
<p>One thing that wasn't explained in the documentation well was how to ETL from one MongoDB to another using the MongodbMixin. The problem when you use the MongodbMixin twice in the same pipe is that it gets confused about which connection to use for which things. Here's how to use pipe groups to fix that.</p>
<div><pre><code><span>var</span> etlProcess <span>=</span> datapumps<span>.</span><span>group</span><span>(</span><span>)</span><span>;</span>

<span>var</span> extractPump <span>=</span> etlProcess<span>.</span><span>addPump</span><span>(</span><span>'extract'</span><span>)</span>
extractPump
  <span>.</span><span>mixin</span><span>(</span><span><span>MongodbMixin</span></span><span>(</span>sourceDbUrl<span>)</span><span>)</span>
  <span>.</span><span>useCollection</span><span>(</span>sourceCollection<span>)</span>
  <span>.</span><span>from</span><span>(</span>extractPump<span>.</span><span>find</span><span>(</span><span>{</span><span>}</span><span>)</span><span>)</span><span>;</span> <span>// take all items from sourceCollection</span>

<span>var</span> upsertPump <span>=</span> etlProcess<span>.</span><span>addPump</span><span>(</span><span>'upsert'</span><span>)</span><span>;</span>
upsertPump
  <span>.</span><span>from</span><span>(</span>extractPump<span>)</span>
  <span>.</span><span>mixin</span><span>(</span><span><span>MongodbMixin</span></span><span>(</span>sinkDbUrl<span>)</span><span>)</span>
  <span>.</span><span>useCollection</span><span>(</span>sinkDbCollection<span>)</span>
  <span>.</span><span>process</span><span>(</span><span>function</span><span>(</span><span>item</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>' - ETLing '</span> <span>+</span> item<span>[</span><span>'_id'</span><span>]</span><span>)</span><span>;</span>
    <span>// need to return a promise from process</span>
    <span>return</span> upsertPump<span>.</span><span>update</span><span>(</span><span>{</span> <span>'_id'</span><span>:</span> item<span>[</span><span>'_id'</span><span>]</span> <span>}</span><span>,</span> item<span>,</span> <span>{</span>upsert<span>:</span> <span>true</span><span>}</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>


etlProcess
  <span>.</span><span>logErrorsToConsole</span><span>(</span><span>)</span>
  <span>.</span><span>start</span><span>(</span><span>)</span>
  <span>.</span><span>whenFinished</span><span>(</span><span>)</span><span>.</span><span>then</span><span>(</span><span>function</span><span>(</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>'finished ETLing.'</span><span>)</span><span>;</span>
    process<span>.</span><span>exit</span><span>(</span><span>0</span><span>)</span><span>;</span>
  <span>}</span><span>)</span><span>;</span>
</code></pre></div>
</article></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"using-node-datapipes-to-etl-from-one-mongodb-to-a-second-mongodb","contentHtml":"\u003cp\u003eETL - not the most fun to write, but the datapipes package makes it pretty easy on NodeJS.\u003c/p\u003e\n\u003cp\u003eOne thing that wasn't explained in the documentation well was how to ETL from one MongoDB to another using the MongodbMixin. The problem when you use the MongodbMixin twice in the same pipe is that it gets confused about which connection to use for which things. Here's how to use pipe groups to fix that.\u003c/p\u003e\n\u003cdiv\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan\u003evar\u003c/span\u003e etlProcess \u003cspan\u003e=\u003c/span\u003e datapumps\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003egroup\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e;\u003c/span\u003e\n\n\u003cspan\u003evar\u003c/span\u003e extractPump \u003cspan\u003e=\u003c/span\u003e etlProcess\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003eaddPump\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e'extract'\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\nextractPump\n  \u003cspan\u003e.\u003c/span\u003e\u003cspan\u003emixin\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e\u003cspan\u003eMongodbMixin\u003c/span\u003e\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003esourceDbUrl\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\n  \u003cspan\u003e.\u003c/span\u003e\u003cspan\u003euseCollection\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003esourceCollection\u003cspan\u003e)\u003c/span\u003e\n  \u003cspan\u003e.\u003c/span\u003e\u003cspan\u003efrom\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003eextractPump\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003efind\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e;\u003c/span\u003e \u003cspan\u003e// take all items from sourceCollection\u003c/span\u003e\n\n\u003cspan\u003evar\u003c/span\u003e upsertPump \u003cspan\u003e=\u003c/span\u003e etlProcess\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003eaddPump\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e'upsert'\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e;\u003c/span\u003e\nupsertPump\n  \u003cspan\u003e.\u003c/span\u003e\u003cspan\u003efrom\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003eextractPump\u003cspan\u003e)\u003c/span\u003e\n  \u003cspan\u003e.\u003c/span\u003e\u003cspan\u003emixin\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e\u003cspan\u003eMongodbMixin\u003c/span\u003e\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003esinkDbUrl\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\n  \u003cspan\u003e.\u003c/span\u003e\u003cspan\u003euseCollection\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003esinkDbCollection\u003cspan\u003e)\u003c/span\u003e\n  \u003cspan\u003e.\u003c/span\u003e\u003cspan\u003eprocess\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003efunction\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003eitem\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e \u003cspan\u003e{\u003c/span\u003e\n    \u003cspan\u003econsole\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003elog\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e' - ETLing '\u003c/span\u003e \u003cspan\u003e+\u003c/span\u003e item\u003cspan\u003e[\u003c/span\u003e\u003cspan\u003e'_id'\u003c/span\u003e\u003cspan\u003e]\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e;\u003c/span\u003e\n    \u003cspan\u003e// need to return a promise from process\u003c/span\u003e\n    \u003cspan\u003ereturn\u003c/span\u003e upsertPump\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003eupdate\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e{\u003c/span\u003e \u003cspan\u003e'_id'\u003c/span\u003e\u003cspan\u003e:\u003c/span\u003e item\u003cspan\u003e[\u003c/span\u003e\u003cspan\u003e'_id'\u003c/span\u003e\u003cspan\u003e]\u003c/span\u003e \u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e,\u003c/span\u003e item\u003cspan\u003e,\u003c/span\u003e \u003cspan\u003e{\u003c/span\u003eupsert\u003cspan\u003e:\u003c/span\u003e \u003cspan\u003etrue\u003c/span\u003e\u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e;\u003c/span\u003e\n  \u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e;\u003c/span\u003e\n\n\netlProcess\n  \u003cspan\u003e.\u003c/span\u003e\u003cspan\u003elogErrorsToConsole\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\n  \u003cspan\u003e.\u003c/span\u003e\u003cspan\u003estart\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\n  \u003cspan\u003e.\u003c/span\u003e\u003cspan\u003ewhenFinished\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003ethen\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003efunction\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e \u003cspan\u003e{\u003c/span\u003e\n    \u003cspan\u003econsole\u003c/span\u003e\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003elog\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e'finished ETLing.'\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e;\u003c/span\u003e\n    process\u003cspan\u003e.\u003c/span\u003e\u003cspan\u003eexit\u003c/span\u003e\u003cspan\u003e(\u003c/span\u003e\u003cspan\u003e0\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e;\u003c/span\u003e\n  \u003cspan\u003e}\u003c/span\u003e\u003cspan\u003e)\u003c/span\u003e\u003cspan\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n","layout":"post","status":"publish","published":true,"title":"Using Node datapipes to ETL from one MongoDB collection to a second MongoDB collection","author":{"display_name":"afiedler","login":"afiedler","email":"andy@andyfiedler.com","url":""},"author_login":"afiedler","author_email":"andy@andyfiedler.com","wordpress_id":321,"wordpress_url":"http://andyfiedler.com/?p=321","date":"2015-07-15 16:14:01 -0400","date_gmt":"2015-07-15 20:14:01 -0400","categories":["Scrapbook"],"tags":["nodejs","mongodb","data"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"using-node-datapipes-to-etl-from-one-mongodb-to-a-second-mongodb"},"buildId":"vPhthCAbGqbPT7mTS8USv","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>