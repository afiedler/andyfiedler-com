<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="description" content="Andy Fiedler&#x27;s Personal Site"/><title>Memory Issues with NodeJS Streams? Remove 0.8.x Streams from Your Pipe</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/588d179d14f543de1f7e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/588d179d14f543de1f7e.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-8495f486508069a84016.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" as="script"/><link rel="preload" href="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.b528922461d10cbe9bfe.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-2f6c726a4c5d3dfd1e8f.js" as="script"/><link rel="preload" href="/_next/static/chunks/0a3463f7b698f32fd7af40216f1292ceb318b3f7.39ce756e4870b72d4174.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-29dccdc32ec4574aab67.js" as="script"/></head><body><div id="__next"><div id="main"><div class="max-w-screen-md mx-auto px-4"><div class="flex items-center justify-between py-6 lg:py-10"><a href="/" class="flex items-center"><p class="font-body font-bold text-2xl text-primary dark:text-white">Andy Fiedler</p></a><div class="flex items-center lg:hidden"><svg width="24" height="15" xmlns="http://www.w3.org/2000/svg" class="fill-current text-primary dark:text-white"><g fill-rule="evenodd"><rect width="24" height="3" rx="1.5"></rect><rect x="8" y="6" width="16" height="3" rx="1.5"></rect><rect x="4" y="12" width="20" height="3" rx="1.5"></rect></g></svg></div><div class="hidden lg:block"><ul class="flex items-center"><li class="mr-6 relative group mb-1"><div class="absolute left-0 bottom-0 w-full transition-all h-0 group-hover:h-2 group-hover:bg-yellow opacity-75 z-20"></div><a href="/posts" class="font-body font-medium text-lg text-primary dark:text-white group-hover:text-green dark:group-hover:text-secondary px-2 z-30 block relative transition-colors">Posts</a></li><li><i class="bx text-3xl text-primary dark:text-white cursor-pointer"></i></li></ul></div><div class="bg-black bg-opacity-80 fixed inset-0 z-20 flex opacity-0 pointer-events-none transition-opacity lg:hidden "><div class="ml-auto bg-blue-600 w-2/3 md:w-1/3 p-4"><svg viewBox="0 0 20 20" width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-white absolute top-0 right-0 mt-4 mr-4"><path d="M15.898,4.045c-0.271-0.272-0.713-0.272-0.986,0l-4.71,4.711L5.493,4.045c-0.272-0.272-0.714-0.272-0.986,0s-0.272,0.714,0,0.986l4.709,4.711l-4.71,4.711c-0.272,0.271-0.272,0.713,0,0.986c0.136,0.136,0.314,0.203,0.492,0.203c0.179,0,0.357-0.067,0.493-0.203l4.711-4.711l4.71,4.711c0.137,0.136,0.314,0.203,0.494,0.203c0.178,0,0.355-0.067,0.492-0.203c0.273-0.273,0.273-0.715,0-0.986l-4.711-4.711l4.711-4.711C16.172,4.759,16.172,4.317,15.898,4.045z"></path></svg><i class="absolute top-0 right-0 mt-4 mr-4"></i><ul class="flex flex-col mt-8"><li class=""><a href="/posts" class="font-body font-medium text-lg text-white px-2 block mb-3">Posts</a></li></ul></div></div></div></div><div class="max-w-screen-md mx-auto px-4"><div class="pt-16 lg:pt-20"><div class="border-b border-grey-lighter pb-8 sm:pb-12"><h2 class="font-body font-semibold text-primary dark:text-white text-3xl sm:text-4xl md:text-5xl block leading-tight">Memory Issues with NodeJS Streams? Remove 0.8.x Streams from Your Pipe</h2><div class="flex items-center pt-5 sm:pt-8"><p class="font-body font-light text-primary dark:text-white pr-2"></p></div></div><article class="border-b border-grey-lighter py-8 sm:py-12 prose prose dark:prose-dark max-w-none"><p>I was working on an ETL process with NodeJS that ran on Heroku, which limits you to 500MB of
memory on a standard dyno. The ETL was quickly running out of memory, even through each
document that it processed was less than 1MB.</p>
<p>This ETL was made up of a <code>Readable</code> stream from a MongoDB <code>Cursor</code>, then two <code>Transform</code>
streams, one using <a href="https://github.com/dominictarr/event-stream"><code>event-stream</code></a> and one
implemented as a subclass of <code>Stream.Transform</code>. The last stream was a <code>Writable</code> stream
that validated and wrote back documents to MongoDB.</p>
<p>Clearly the readable stream was reading documents out of Mongo way too quickly for the
transform streams to do their work and the writable stream to write the documents back to
MongoDB. But wasn't NodeJS suppose to manage this automatically, assuming the <code>highWaterMark</code>
was set to something reasonable?</p>
<p>It turns our that, yes, NodeJS does manage this correctly, as long as <em>every stream in your pipe
is a 0.10.x stream or greater</em>. NodeJS implemented the
<a href="https://nodejs.org/en/blog/feature/streams2/"><code>highWaterMark</code> in Node 0.10.x</a>.</p>
<p>The culprit in my case was <code>event-stream</code>, which is an old library that only makes 0.8.x streams.</p>
<p>Moral of the story: if you are having memory issues with streams that seem like backpressure
should be solving, make sure all of the streams in your pipe are 0.10.x streams or greater!</p>
</article></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"nodejs-streams-memory-issues-and-backpressure","contentHtml":"\u003cp\u003eI was working on an ETL process with NodeJS that ran on Heroku, which limits you to 500MB of\nmemory on a standard dyno. The ETL was quickly running out of memory, even through each\ndocument that it processed was less than 1MB.\u003c/p\u003e\n\u003cp\u003eThis ETL was made up of a \u003ccode\u003eReadable\u003c/code\u003e stream from a MongoDB \u003ccode\u003eCursor\u003c/code\u003e, then two \u003ccode\u003eTransform\u003c/code\u003e\nstreams, one using \u003ca href=\"https://github.com/dominictarr/event-stream\"\u003e\u003ccode\u003eevent-stream\u003c/code\u003e\u003c/a\u003e and one\nimplemented as a subclass of \u003ccode\u003eStream.Transform\u003c/code\u003e. The last stream was a \u003ccode\u003eWritable\u003c/code\u003e stream\nthat validated and wrote back documents to MongoDB.\u003c/p\u003e\n\u003cp\u003eClearly the readable stream was reading documents out of Mongo way too quickly for the\ntransform streams to do their work and the writable stream to write the documents back to\nMongoDB. But wasn't NodeJS suppose to manage this automatically, assuming the \u003ccode\u003ehighWaterMark\u003c/code\u003e\nwas set to something reasonable?\u003c/p\u003e\n\u003cp\u003eIt turns our that, yes, NodeJS does manage this correctly, as long as \u003cem\u003eevery stream in your pipe\nis a 0.10.x stream or greater\u003c/em\u003e. NodeJS implemented the\n\u003ca href=\"https://nodejs.org/en/blog/feature/streams2/\"\u003e\u003ccode\u003ehighWaterMark\u003c/code\u003e in Node 0.10.x\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThe culprit in my case was \u003ccode\u003eevent-stream\u003c/code\u003e, which is an old library that only makes 0.8.x streams.\u003c/p\u003e\n\u003cp\u003eMoral of the story: if you are having memory issues with streams that seem like backpressure\nshould be solving, make sure all of the streams in your pipe are 0.10.x streams or greater!\u003c/p\u003e\n","layout":"post","title":"Memory Issues with NodeJS Streams? Remove 0.8.x Streams from Your Pipe"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"nodejs-streams-memory-issues-and-backpressure"},"buildId":"kin1HMdhXCenXl5fEijbK","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-144e5fa6fafab6397d9c.js"></script><script src="/_next/static/chunks/main-8495f486508069a84016.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" async=""></script><script src="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.b528922461d10cbe9bfe.js" async=""></script><script src="/_next/static/chunks/pages/_app-2f6c726a4c5d3dfd1e8f.js" async=""></script><script src="/_next/static/chunks/0a3463f7b698f32fd7af40216f1292ceb318b3f7.39ce756e4870b72d4174.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-29dccdc32ec4574aab67.js" async=""></script><script src="/_next/static/kin1HMdhXCenXl5fEijbK/_buildManifest.js" async=""></script><script src="/_next/static/kin1HMdhXCenXl5fEijbK/_ssgManifest.js" async=""></script></body></html>