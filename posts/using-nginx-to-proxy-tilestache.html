<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="description" content="Andy Fiedler&#x27;s Personal Site"/><title>Using NGINX to proxy TileStache </title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/588d179d14f543de1f7e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/588d179d14f543de1f7e.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-8495f486508069a84016.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" as="script"/><link rel="preload" href="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.b528922461d10cbe9bfe.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-2f6c726a4c5d3dfd1e8f.js" as="script"/><link rel="preload" href="/_next/static/chunks/0a3463f7b698f32fd7af40216f1292ceb318b3f7.39ce756e4870b72d4174.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-29dccdc32ec4574aab67.js" as="script"/></head><body><div id="__next"><div id="main"><div class="max-w-screen-md mx-auto px-4"><div class="flex items-center justify-between py-6 lg:py-10"><a href="/" class="flex items-center"><p class="font-body font-bold text-2xl text-primary dark:text-white">Andy Fiedler</p></a><div class="flex items-center lg:hidden"><svg width="24" height="15" xmlns="http://www.w3.org/2000/svg" class="fill-current text-primary dark:text-white"><g fill-rule="evenodd"><rect width="24" height="3" rx="1.5"></rect><rect x="8" y="6" width="16" height="3" rx="1.5"></rect><rect x="4" y="12" width="20" height="3" rx="1.5"></rect></g></svg></div><div class="hidden lg:block"><ul class="flex items-center"><li class="mr-6 relative group mb-1"><div class="absolute left-0 bottom-0 w-full transition-all h-0 group-hover:h-2 group-hover:bg-yellow opacity-75 z-20"></div><a href="/posts" class="font-body font-medium text-lg text-primary dark:text-white group-hover:text-green dark:group-hover:text-secondary px-2 z-30 block relative transition-colors">Posts</a></li><li><i class="bx text-3xl text-primary dark:text-white cursor-pointer"></i></li></ul></div><div class="bg-black bg-opacity-80 fixed inset-0 z-20 flex opacity-0 pointer-events-none transition-opacity lg:hidden "><div class="ml-auto bg-blue-600 w-2/3 md:w-1/3 p-4"><svg viewBox="0 0 20 20" width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-white absolute top-0 right-0 mt-4 mr-4"><path d="M15.898,4.045c-0.271-0.272-0.713-0.272-0.986,0l-4.71,4.711L5.493,4.045c-0.272-0.272-0.714-0.272-0.986,0s-0.272,0.714,0,0.986l4.709,4.711l-4.71,4.711c-0.272,0.271-0.272,0.713,0,0.986c0.136,0.136,0.314,0.203,0.492,0.203c0.179,0,0.357-0.067,0.493-0.203l4.711-4.711l4.71,4.711c0.137,0.136,0.314,0.203,0.494,0.203c0.178,0,0.355-0.067,0.492-0.203c0.273-0.273,0.273-0.715,0-0.986l-4.711-4.711l4.711-4.711C16.172,4.759,16.172,4.317,15.898,4.045z"></path></svg><i class="absolute top-0 right-0 mt-4 mr-4"></i><ul class="flex flex-col mt-8"><li class=""><a href="/posts" class="font-body font-medium text-lg text-white px-2 block mb-3">Posts</a></li></ul></div></div></div></div><div class="max-w-screen-md mx-auto px-4"><div class="pt-16 lg:pt-20"><div class="border-b border-grey-lighter pb-8 sm:pb-12"><h2 class="font-body font-semibold text-primary dark:text-white text-3xl sm:text-4xl md:text-5xl block leading-tight">Using NGINX to proxy TileStache </h2><div class="flex items-center pt-5 sm:pt-8"><p class="font-body font-light text-primary dark:text-white pr-2">2012-08-30 12:54:18 -0400</p></div></div><article class="border-b border-grey-lighter py-8 sm:py-12 prose prose dark:prose-dark max-w-none"><p>I'm working on a re-rendering of OpenStreetMap for hiking, with hill shading and topographic lines and I decided to use TileStache to render the tiles. TileStache has the nice ability to render tiles from a bunch of different sources and then overlay them with different amounts of transparency and layer masks (just like Photoshop). TileStache is a Python WSGI server that you can run in mod_python or GUnicorn to serve tiles directly over HTTP. TileStache can cache map tiles to the file system and serve the static PNGs if they exist or render them from scratch using Mapnik if they don't. Its pretty fast, especially if the tiles are pre-rendered.</p>
<p>However, GUnicorn is a pre-forking server. This means that it needs to fork a different process for each client connection. What happens if a slow client connects is that TileStache processes are rapidly used up to serve that client (typically clients make up to 8 separate HTTP connections for slippy maps, resulting in 8 processes each!). This is the case even if the tiles are being served from cache.</p>
<p>What you need to do is add a reverse proxy in front of GUnicorn, using something like NGINX. The reverse proxy using an evented IO model, which enables it to manage sending data back to a slow client without using an operating system process. NGINX can also directly serve static assets from the filesystem, which means we can serve the cached tiles without even hitting GUnicorn&#47;TileStache.</p>
<p>Getting this to work requires a bit of NGINX HttpRewriteModule voodoo, though. The issue is that TileStache saves cached tiles in a slightly different path than the URI path that comes in via HTTP. Say you have a OpenStreetMap-style URL like this: <code>myserver.com&#47;tiles&#47;layer&#47;$z&#47;$x&#47;$y.png<&#47;code>. In this URL, <code>$z<&#47;code> is zoom level (usually 1-19), and <code>$x<&#47;code> and <code>$y<&#47;code> are tile coordinates. For higher zoom levels, you can have 10,000+ by 10,0000+ tiles in the x and y directions. That's way too many PNG files to store in one folder on the filesystem. So, TileStache splits up the x and y paths into two levels. Say you have a URL like <code>&#47;tiles&#47;layer&#47;7&#47;12345&#47;67890.png<&#47;code>. TileStache will store that in the filesystem path <code>&#47;tiles&#47;layer&#47;7&#47;012&#47;345&#47;067&#47;890.png<&#47;code>. Notice how 12345 is broken into 012&#47;345? That means that there will be at most 1,000 files or folders in each directory&mdash;a manageable amount. The issue is we need to get NGINX to rewrite URLs to server these static assets. Here's how I accomplished that:</p>
<pre class="lang:default highlight:0 decode:true" title="Main NGINX location directive">	location ~ ^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]+)\&#47;([\d]+)\.png {<br />
		root &#47;osm&#47;cache;</p>
<p>		set $originaluri &#47;$1&#47;$2&#47;$3&#47;$4.png;</p>
<p>		# 1 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;000&#47;00$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;000&#47;0$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;000&#47;$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;00$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;0$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;$4&#47;$5.png break;</p>
<p>		# 2 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;000&#47;00$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;000&#47;0$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;000&#47;$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;00$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;0$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;$4&#47;$5.png break;</p>
<p>		# 3 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;000&#47;00$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;000&#47;0$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;000&#47;$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;00$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;0$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;$4&#47;$5.png break;</p>
<p>		# 4 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;000&#47;00$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;000&#47;0$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;000&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;00$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;0$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;$5&#47;$6.png break;</p>
<p>		# 5 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;000&#47;00$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;000&#47;0$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;000&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;00$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;0$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;$5&#47;$6.png break;</p>
<p>		# 6 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;000&#47;00$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;000&#47;0$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;000&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;00$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;0$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;$5&#47;$6.png break;</p>
<p>		# Try to serve the file from the disk. If that doesn't work, pass through the request via the proxy<br />
		try_files $uri @tilestache;<br />
	}<&#47;pre><br />
This mountain of rewrite lines will rewrite the request URL to the filesystem format, then look for tiles in the filesystem tree starting at <code>&#47;osm&#47;cache<&#47;code>. The last line tells NGINX to look for the rewritten URL, then if the file is not found, to send the request to the <code>@tilestache;<&#47;code> location block, which looks like this:</p>
<pre class="lang:default highlight:0 decode:true " title="Proxy NGINX block">	 location @tilestache {</p>
<p>		# Rewrite back to standard OSM form<br />
		rewrite ^(.*)$ $originaluri break;<br />
		add_header X-Static miss;<br />
		proxy_pass http:&#47;&#47;127.0.0.1:8080;<br />
		proxy_set_header Host $http_host;<br />
	}<&#47;pre><br />
That location block proxies the request to the GUnicorn server listening on localhost:8080.</p>
<p>This seems to be working great. NGINX is far faster in serving static assets, and if all of the worker TileStache processes are busy rendering, the cached zoom levels of the map work fine!</p>
</article></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"using-nginx-to-proxy-tilestache","contentHtml":"\u003cp\u003eI'm working on a re-rendering of OpenStreetMap for hiking, with hill shading and topographic lines and I decided to use TileStache to render the tiles. TileStache has the nice ability to render tiles from a bunch of different sources and then overlay them with different amounts of transparency and layer masks (just like Photoshop). TileStache is a Python WSGI server that you can run in mod_python or GUnicorn to serve tiles directly over HTTP. TileStache can cache map tiles to the file system and serve the static PNGs if they exist or render them from scratch using Mapnik if they don't. Its pretty fast, especially if the tiles are pre-rendered.\u003c/p\u003e\n\u003cp\u003eHowever, GUnicorn is a pre-forking server. This means that it needs to fork a different process for each client connection. What happens if a slow client connects is that TileStache processes are rapidly used up to serve that client (typically clients make up to 8 separate HTTP connections for slippy maps, resulting in 8 processes each!). This is the case even if the tiles are being served from cache.\u003c/p\u003e\n\u003cp\u003eWhat you need to do is add a reverse proxy in front of GUnicorn, using something like NGINX. The reverse proxy using an evented IO model, which enables it to manage sending data back to a slow client without using an operating system process. NGINX can also directly serve static assets from the filesystem, which means we can serve the cached tiles without even hitting GUnicorn\u0026#47;TileStache.\u003c/p\u003e\n\u003cp\u003eGetting this to work requires a bit of NGINX HttpRewriteModule voodoo, though. The issue is that TileStache saves cached tiles in a slightly different path than the URI path that comes in via HTTP. Say you have a OpenStreetMap-style URL like this: \u003ccode\u003emyserver.com\u0026#47;tiles\u0026#47;layer\u0026#47;$z\u0026#47;$x\u0026#47;$y.png\u003c\u0026#47;code\u003e. In this URL, \u003ccode\u003e$z\u003c\u0026#47;code\u003e is zoom level (usually 1-19), and \u003ccode\u003e$x\u003c\u0026#47;code\u003e and \u003ccode\u003e$y\u003c\u0026#47;code\u003e are tile coordinates. For higher zoom levels, you can have 10,000+ by 10,0000+ tiles in the x and y directions. That's way too many PNG files to store in one folder on the filesystem. So, TileStache splits up the x and y paths into two levels. Say you have a URL like \u003ccode\u003e\u0026#47;tiles\u0026#47;layer\u0026#47;7\u0026#47;12345\u0026#47;67890.png\u003c\u0026#47;code\u003e. TileStache will store that in the filesystem path \u003ccode\u003e\u0026#47;tiles\u0026#47;layer\u0026#47;7\u0026#47;012\u0026#47;345\u0026#47;067\u0026#47;890.png\u003c\u0026#47;code\u003e. Notice how 12345 is broken into 012\u0026#47;345? That means that there will be at most 1,000 files or folders in each directory\u0026mdash;a manageable amount. The issue is we need to get NGINX to rewrite URLs to server these static assets. Here's how I accomplished that:\u003c/p\u003e\n\u003cpre class=\"lang:default highlight:0 decode:true\" title=\"Main NGINX location directive\"\u003e\tlocation ~ ^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]+)\\.png {\u003cbr /\u003e\n\t\troot \u0026#47;osm\u0026#47;cache;\u003c/p\u003e\n\u003cp\u003e\t\tset $originaluri \u0026#47;$1\u0026#47;$2\u0026#47;$3\u0026#47;$4.png;\u003c/p\u003e\n\u003cp\u003e\t\t# 1 char X\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})\\\u0026#47;([\\d]{1}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;00$3\u0026#47;000\u0026#47;00$4.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})\\\u0026#47;([\\d]{2}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;00$3\u0026#47;000\u0026#47;0$4.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})\\\u0026#47;([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;00$3\u0026#47;000\u0026#47;$4.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})\\\u0026#47;([\\d]{1})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;00$3\u0026#47;00$4\u0026#47;$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})\\\u0026#47;([\\d]{2})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;00$3\u0026#47;0$4\u0026#47;$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})\\\u0026#47;([\\d]{3})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;00$3\u0026#47;$4\u0026#47;$5.png break;\u003c/p\u003e\n\u003cp\u003e\t\t# 2 char X\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})\\\u0026#47;([\\d]{1}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;0$3\u0026#47;000\u0026#47;00$4.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})\\\u0026#47;([\\d]{2}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;0$3\u0026#47;000\u0026#47;0$4.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})\\\u0026#47;([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;0$3\u0026#47;000\u0026#47;$4.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})\\\u0026#47;([\\d]{1})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;0$3\u0026#47;00$4\u0026#47;$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})\\\u0026#47;([\\d]{2})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;0$3\u0026#47;0$4\u0026#47;$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})\\\u0026#47;([\\d]{3})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;0$3\u0026#47;$4\u0026#47;$5.png break;\u003c/p\u003e\n\u003cp\u003e\t\t# 3 char X\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})\\\u0026#47;([\\d]{1}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;$3\u0026#47;000\u0026#47;00$4.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})\\\u0026#47;([\\d]{2}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;$3\u0026#47;000\u0026#47;0$4.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})\\\u0026#47;([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;$3\u0026#47;000\u0026#47;$4.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})\\\u0026#47;([\\d]{1})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;$3\u0026#47;00$4\u0026#47;$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})\\\u0026#47;([\\d]{2})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;$3\u0026#47;0$4\u0026#47;$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})\\\u0026#47;([\\d]{3})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;000\u0026#47;$3\u0026#47;$4\u0026#47;$5.png break;\u003c/p\u003e\n\u003cp\u003e\t\t# 4 char X\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})([\\d]{3})\\\u0026#47;([\\d]{1}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;00$3\u0026#47;$4\u0026#47;000\u0026#47;00$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})([\\d]{3})\\\u0026#47;([\\d]{2}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;00$3\u0026#47;$4\u0026#47;000\u0026#47;0$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})([\\d]{3})\\\u0026#47;([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;00$3\u0026#47;$4\u0026#47;000\u0026#47;$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})([\\d]{3})\\\u0026#47;([\\d]{1})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;00$3\u0026#47;$4\u0026#47;00$5\u0026#47;$6.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})([\\d]{3})\\\u0026#47;([\\d]{2})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;00$3\u0026#47;$4\u0026#47;0$5\u0026#47;$6.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{1})([\\d]{3})\\\u0026#47;([\\d]{3})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;00$3\u0026#47;$4\u0026#47;$5\u0026#47;$6.png break;\u003c/p\u003e\n\u003cp\u003e\t\t# 5 char X\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})([\\d]{3})\\\u0026#47;([\\d]{1}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;0$3\u0026#47;$4\u0026#47;000\u0026#47;00$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})([\\d]{3})\\\u0026#47;([\\d]{2}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;0$3\u0026#47;$4\u0026#47;000\u0026#47;0$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})([\\d]{3})\\\u0026#47;([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;0$3\u0026#47;$4\u0026#47;000\u0026#47;$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})([\\d]{3})\\\u0026#47;([\\d]{1})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;0$3\u0026#47;$4\u0026#47;00$5\u0026#47;$6.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})([\\d]{3})\\\u0026#47;([\\d]{2})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;0$3\u0026#47;$4\u0026#47;0$5\u0026#47;$6.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{2})([\\d]{3})\\\u0026#47;([\\d]{3})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;0$3\u0026#47;$4\u0026#47;$5\u0026#47;$6.png break;\u003c/p\u003e\n\u003cp\u003e\t\t# 6 char X\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})([\\d]{3})\\\u0026#47;([\\d]{1}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;$3\u0026#47;$4\u0026#47;000\u0026#47;00$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})([\\d]{3})\\\u0026#47;([\\d]{2}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;$3\u0026#47;$4\u0026#47;000\u0026#47;0$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})([\\d]{3})\\\u0026#47;([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;$3\u0026#47;$4\u0026#47;000\u0026#47;$5.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})([\\d]{3})\\\u0026#47;([\\d]{1})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;$3\u0026#47;$4\u0026#47;00$5\u0026#47;$6.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})([\\d]{3})\\\u0026#47;([\\d]{2})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;$3\u0026#47;$4\u0026#47;0$5\u0026#47;$6.png break;\u003cbr /\u003e\n\t\trewrite \"^\\\u0026#47;tiles\\\u0026#47;([\\w\\-]+)\\\u0026#47;([\\d]+)\\\u0026#47;([\\d]{3})([\\d]{3})\\\u0026#47;([\\d]{3})([\\d]{3}).png$\" \u0026#47;$1\u0026#47;$2\u0026#47;$3\u0026#47;$4\u0026#47;$5\u0026#47;$6.png break;\u003c/p\u003e\n\u003cp\u003e\t\t# Try to serve the file from the disk. If that doesn't work, pass through the request via the proxy\u003cbr /\u003e\n\t\ttry_files $uri @tilestache;\u003cbr /\u003e\n\t}\u003c\u0026#47;pre\u003e\u003cbr /\u003e\nThis mountain of rewrite lines will rewrite the request URL to the filesystem format, then look for tiles in the filesystem tree starting at \u003ccode\u003e\u0026#47;osm\u0026#47;cache\u003c\u0026#47;code\u003e. The last line tells NGINX to look for the rewritten URL, then if the file is not found, to send the request to the \u003ccode\u003e@tilestache;\u003c\u0026#47;code\u003e location block, which looks like this:\u003c/p\u003e\n\u003cpre class=\"lang:default highlight:0 decode:true \" title=\"Proxy NGINX block\"\u003e\t location @tilestache {\u003c/p\u003e\n\u003cp\u003e\t\t# Rewrite back to standard OSM form\u003cbr /\u003e\n\t\trewrite ^(.*)$ $originaluri break;\u003cbr /\u003e\n\t\tadd_header X-Static miss;\u003cbr /\u003e\n\t\tproxy_pass http:\u0026#47;\u0026#47;127.0.0.1:8080;\u003cbr /\u003e\n\t\tproxy_set_header Host $http_host;\u003cbr /\u003e\n\t}\u003c\u0026#47;pre\u003e\u003cbr /\u003e\nThat location block proxies the request to the GUnicorn server listening on localhost:8080.\u003c/p\u003e\n\u003cp\u003eThis seems to be working great. NGINX is far faster in serving static assets, and if all of the worker TileStache processes are busy rendering, the cached zoom levels of the map work fine!\u003c/p\u003e\n","layout":"post","status":"publish","published":true,"title":"Using NGINX to proxy TileStache ","author":{"display_name":"afiedler","login":"afiedler","email":"andy@andyfiedler.com","url":""},"author_login":"afiedler","author_email":"andy@andyfiedler.com","wordpress_id":180,"wordpress_url":"http://andyfiedler.com/?p=180","date":"2012-08-30 12:54:18 -0400","date_gmt":"2012-08-30 16:54:18 -0400","categories":["Tech Notes"],"tags":[]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"using-nginx-to-proxy-tilestache"},"buildId":"au-zTTOac9_rvw04kgZaC","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-144e5fa6fafab6397d9c.js"></script><script src="/_next/static/chunks/main-8495f486508069a84016.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" async=""></script><script src="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.b528922461d10cbe9bfe.js" async=""></script><script src="/_next/static/chunks/pages/_app-2f6c726a4c5d3dfd1e8f.js" async=""></script><script src="/_next/static/chunks/0a3463f7b698f32fd7af40216f1292ceb318b3f7.39ce756e4870b72d4174.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-29dccdc32ec4574aab67.js" async=""></script><script src="/_next/static/au-zTTOac9_rvw04kgZaC/_buildManifest.js" async=""></script><script src="/_next/static/au-zTTOac9_rvw04kgZaC/_ssgManifest.js" async=""></script></body></html>