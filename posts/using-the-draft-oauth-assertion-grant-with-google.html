<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="description" content="Andy Fiedler&#x27;s Personal Site"/><title>Using the Draft OAuth Assertion Grant with Google+</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/588d179d14f543de1f7e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/588d179d14f543de1f7e.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-8495f486508069a84016.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" as="script"/><link rel="preload" href="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.b528922461d10cbe9bfe.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-2f6c726a4c5d3dfd1e8f.js" as="script"/><link rel="preload" href="/_next/static/chunks/0a3463f7b698f32fd7af40216f1292ceb318b3f7.39ce756e4870b72d4174.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-29dccdc32ec4574aab67.js" as="script"/></head><body><div id="__next"><div id="main"><div class="max-w-screen-md mx-auto px-4"><div class="flex items-center justify-between py-6 lg:py-10"><a href="/" class="flex items-center"><p class="font-body font-bold text-2xl text-primary dark:text-white">Andy Fiedler</p></a><div class="flex items-center lg:hidden"><svg width="24" height="15" xmlns="http://www.w3.org/2000/svg" class="fill-current text-primary dark:text-white"><g fill-rule="evenodd"><rect width="24" height="3" rx="1.5"></rect><rect x="8" y="6" width="16" height="3" rx="1.5"></rect><rect x="4" y="12" width="20" height="3" rx="1.5"></rect></g></svg></div><div class="hidden lg:block"><ul class="flex items-center"><li class="mr-6 relative group mb-1"><div class="absolute left-0 bottom-0 w-full transition-all h-0 group-hover:h-2 group-hover:bg-yellow opacity-75 z-20"></div><a href="/posts" class="font-body font-medium text-lg text-primary dark:text-white group-hover:text-green dark:group-hover:text-secondary px-2 z-30 block relative transition-colors">Posts</a></li><li><i class="bx text-3xl text-primary dark:text-white cursor-pointer"></i></li></ul></div><div class="bg-black bg-opacity-80 fixed inset-0 z-20 flex opacity-0 pointer-events-none transition-opacity lg:hidden "><div class="ml-auto bg-blue-600 w-2/3 md:w-1/3 p-4"><svg viewBox="0 0 20 20" width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-white absolute top-0 right-0 mt-4 mr-4"><path d="M15.898,4.045c-0.271-0.272-0.713-0.272-0.986,0l-4.71,4.711L5.493,4.045c-0.272-0.272-0.714-0.272-0.986,0s-0.272,0.714,0,0.986l4.709,4.711l-4.71,4.711c-0.272,0.271-0.272,0.713,0,0.986c0.136,0.136,0.314,0.203,0.492,0.203c0.179,0,0.357-0.067,0.493-0.203l4.711-4.711l4.71,4.711c0.137,0.136,0.314,0.203,0.494,0.203c0.178,0,0.355-0.067,0.492-0.203c0.273-0.273,0.273-0.715,0-0.986l-4.711-4.711l4.711-4.711C16.172,4.759,16.172,4.317,15.898,4.045z"></path></svg><i class="absolute top-0 right-0 mt-4 mr-4"></i><ul class="flex flex-col mt-8"><li class=""><a href="/posts" class="font-body font-medium text-lg text-white px-2 block mb-3">Posts</a></li></ul></div></div></div></div><div class="max-w-screen-md mx-auto px-4"><div class="pt-16 lg:pt-20"><div class="border-b border-grey-lighter pb-8 sm:pb-12"><h2 class="font-body font-semibold text-primary dark:text-white text-3xl sm:text-4xl md:text-5xl block leading-tight">Using the Draft OAuth Assertion Grant with Google+</h2><div class="flex items-center pt-5 sm:pt-8"><p class="font-body font-light text-primary dark:text-white pr-2">2014-09-10 14:38:35 -0400</p></div></div><article class="border-b border-grey-lighter py-8 sm:py-12 prose prose dark:prose-dark max-w-none"><p>The IETF has been working on a <a href="https://tools.ietf.org/html/draft-ietf-oauth-assertions-17">new OAuth standard for "assertions"</a> which enables OAuth to work with other types of authentication systems. This can be used to allow users to authenticate with your API through Google+ or other third-party identity providers.</p>
<p>For example, let's say you are developing a single-page Javascript app or a mobile app that uses both Google's APIs as well as your own APIs. You'd like to have users authenticate with Google to obtain access to Google's APIs, but then you'd also like your app to authenticate with your server to gain access to some additional resources. You'd like to not reinvent the wheel and use OAuth for your own API. You also implicitly trust Google to verify the user's identity, so you don't want the user to need to go through another OAuth flow just to use your API.</p>
<p>Assertion grants allow you to do this in a standards-compliant way. This is a draft standard that was just submitted in July of 2014, but for this simple use-case, it is already fairly usable.</p>
<h2>How Google+ handles sign in for "combination" apps (with both a client and a server)</h2>
Google has <a href="https://developers.google.com/+/web/signin/server-side-flow#step_6_send_the_authorization_code_to_the_server">some great documentation on how to authenticate both a client and a server</a>, which is worth reading if you plan on implementing this. The gist of it is that first the client authenticates with Google through a OAuth popup or redirect. This gives the client both an access token and an access code. The code is then passed to the server to authenticate the backend.
<p>This "passing the code to the backend step" is what OAuth assertion grants enable in a standards-compliant way.</p>
<h2>OAuth Assertion Grants</h2>
The IETF Assertion Grant spec defines a way to define new grant types that are assertions of identity from third parties. An assertion grant looks like this (from the <a href="https://tools.ietf.org/html/draft-ietf-oauth-assertions-17#section-4.1">example in the spec</a>):
<pre class="lang:js decode:true">{
   "grant_type": "urn:ietf:params:oauth:grant-type:saml2-bearer",
   "assertion": "PHNhbWxwOl...[omitted for brevity]...ZT4",
   "scope": ""
}</pre>
Assertions are very similar to <a href="http://tools.ietf.org/html/rfc6749#section-4.3">Resource Owner Password Credential grants</a> in that they are passed as HTTP POSTs directly to the <code>/token</code> endpoint. The "grant_type" for an assertion must be a absolute URI that defines the assertion type, the "assertion" is a Base64-encoded string (using URL-safe encoding) that contains the actual asserrtion, and the "scope" is the same as other OAuth grant types.
<h2>An OAuth Assertion Grant for Google+</h2>
Since Google has not defined an assertion grant format for Google+ identity, I've decided to make one up! You can feel free to steal this format for your own apps.
<pre class="lang:js decode:true">{
   "grant_type": "urn:googlepluscode",
   "assertion": "(see below)",
   "scope": "(specific to your app)"
}</pre>
For my Google+ assertion grant, I've just chose "urn:googlepluscode" as the URL. This is arbitrary, but Google would need to standardize this so we currently don't have a better option. For the assertion itself, I use a Base64-encoded, url-safe version of this JSON:
<pre lanng:js="" decode:true="">{
   "code": "(access code provided by the front-end when it authenticates with Google)",
   "google_plus_user_id": "(Google+ user ID)"
}</pre>
<h2>Verifying the Google+ assertion grant</h2>
When the backend receives the Google+ assertion grant, it should do these steps to verify it:
<ol>
	<li>Convert the access code into an access token</li>
	<li>Call the <code>/oauth/tokeninfo</code> endpoint with the access token from the previous step</li>
	<li>In the response from the <code>tokeninfo</code> endpoint, confirm these things:
<ol>
	<li>The <code>user_id</code> matches the <code>google_plus_user_id</code> in the assertion</li>
	<li>The <code>issued_to</code> from the <code>tokeninfo</code> response matches the <code>client_id</code> of your application (both the front-end and back-end share the same <code>client_id</code>.</li>
</ol>
</li>
</ol>
Stay tuned for a future post on how to implement this with Rails and <a href="https://github.com/doorkeeper-gem/doorkeeper">Doorkeeper</a>!
</article></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"using-the-draft-oauth-assertion-grant-with-google","contentHtml":"\u003cp\u003eThe IETF has been working on a \u003ca href=\"https://tools.ietf.org/html/draft-ietf-oauth-assertions-17\"\u003enew OAuth standard for \"assertions\"\u003c/a\u003e which enables OAuth to work with other types of authentication systems. This can be used to allow users to authenticate with your API through Google+ or other third-party identity providers.\u003c/p\u003e\n\u003cp\u003eFor example, let's say you are developing a single-page Javascript app or a mobile app that uses both Google's APIs as well as your own APIs. You'd like to have users authenticate with Google to obtain access to Google's APIs, but then you'd also like your app to authenticate with your server to gain access to some additional resources. You'd like to not reinvent the wheel and use OAuth for your own API. You also implicitly trust Google to verify the user's identity, so you don't want the user to need to go through another OAuth flow just to use your API.\u003c/p\u003e\n\u003cp\u003eAssertion grants allow you to do this in a standards-compliant way. This is a draft standard that was just submitted in July of 2014, but for this simple use-case, it is already fairly usable.\u003c/p\u003e\n\u003ch2\u003eHow Google+ handles sign in for \"combination\" apps (with both a client and a server)\u003c/h2\u003e\nGoogle has \u003ca href=\"https://developers.google.com/+/web/signin/server-side-flow#step_6_send_the_authorization_code_to_the_server\"\u003esome great documentation on how to authenticate both a client and a server\u003c/a\u003e, which is worth reading if you plan on implementing this. The gist of it is that first the client authenticates with Google through a OAuth popup or redirect. This gives the client both an access token and an access code. The code is then passed to the server to authenticate the backend.\n\u003cp\u003eThis \"passing the code to the backend step\" is what OAuth assertion grants enable in a standards-compliant way.\u003c/p\u003e\n\u003ch2\u003eOAuth Assertion Grants\u003c/h2\u003e\nThe IETF Assertion Grant spec defines a way to define new grant types that are assertions of identity from third parties. An assertion grant looks like this (from the \u003ca href=\"https://tools.ietf.org/html/draft-ietf-oauth-assertions-17#section-4.1\"\u003eexample in the spec\u003c/a\u003e):\n\u003cpre class=\"lang:js decode:true\"\u003e{\n   \"grant_type\": \"urn:ietf:params:oauth:grant-type:saml2-bearer\",\n   \"assertion\": \"PHNhbWxwOl...[omitted for brevity]...ZT4\",\n   \"scope\": \"\"\n}\u003c/pre\u003e\nAssertions are very similar to \u003ca href=\"http://tools.ietf.org/html/rfc6749#section-4.3\"\u003eResource Owner Password Credential grants\u003c/a\u003e in that they are passed as HTTP POSTs directly to the \u003ccode\u003e/token\u003c/code\u003e endpoint. The \"grant_type\" for an assertion must be a absolute URI that defines the assertion type, the \"assertion\" is a Base64-encoded string (using URL-safe encoding) that contains the actual asserrtion, and the \"scope\" is the same as other OAuth grant types.\n\u003ch2\u003eAn OAuth Assertion Grant for Google+\u003c/h2\u003e\nSince Google has not defined an assertion grant format for Google+ identity, I've decided to make one up! You can feel free to steal this format for your own apps.\n\u003cpre class=\"lang:js decode:true\"\u003e{\n   \"grant_type\": \"urn:googlepluscode\",\n   \"assertion\": \"(see below)\",\n   \"scope\": \"(specific to your app)\"\n}\u003c/pre\u003e\nFor my Google+ assertion grant, I've just chose \"urn:googlepluscode\" as the URL. This is arbitrary, but Google would need to standardize this so we currently don't have a better option. For the assertion itself, I use a Base64-encoded, url-safe version of this JSON:\n\u003cpre lanng:js=\"\" decode:true=\"\"\u003e{\n   \"code\": \"(access code provided by the front-end when it authenticates with Google)\",\n   \"google_plus_user_id\": \"(Google+ user ID)\"\n}\u003c/pre\u003e\n\u003ch2\u003eVerifying the Google+ assertion grant\u003c/h2\u003e\nWhen the backend receives the Google+ assertion grant, it should do these steps to verify it:\n\u003col\u003e\n\t\u003cli\u003eConvert the access code into an access token\u003c/li\u003e\n\t\u003cli\u003eCall the \u003ccode\u003e/oauth/tokeninfo\u003c/code\u003e endpoint with the access token from the previous step\u003c/li\u003e\n\t\u003cli\u003eIn the response from the \u003ccode\u003etokeninfo\u003c/code\u003e endpoint, confirm these things:\n\u003col\u003e\n\t\u003cli\u003eThe \u003ccode\u003euser_id\u003c/code\u003e matches the \u003ccode\u003egoogle_plus_user_id\u003c/code\u003e in the assertion\u003c/li\u003e\n\t\u003cli\u003eThe \u003ccode\u003eissued_to\u003c/code\u003e from the \u003ccode\u003etokeninfo\u003c/code\u003e response matches the \u003ccode\u003eclient_id\u003c/code\u003e of your application (both the front-end and back-end share the same \u003ccode\u003eclient_id\u003c/code\u003e.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\nStay tuned for a future post on how to implement this with Rails and \u003ca href=\"https://github.com/doorkeeper-gem/doorkeeper\"\u003eDoorkeeper\u003c/a\u003e!\n","layout":"post","status":"publish","published":true,"title":"Using the Draft OAuth Assertion Grant with Google+","author":{"display_name":"afiedler","login":"afiedler","email":"andy@andyfiedler.com","url":""},"author_login":"afiedler","author_email":"andy@andyfiedler.com","wordpress_id":283,"wordpress_url":"http://andyfiedler.com/?p=283","date":"2014-09-10 14:38:35 -0400","date_gmt":"2014-09-10 18:38:35 -0400","categories":["Tech Notes","Web Development"],"tags":["oauth","google+"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"using-the-draft-oauth-assertion-grant-with-google"},"buildId":"kin1HMdhXCenXl5fEijbK","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-144e5fa6fafab6397d9c.js"></script><script src="/_next/static/chunks/main-8495f486508069a84016.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.abffcf18e526b7c0dbcd.js" async=""></script><script src="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.b528922461d10cbe9bfe.js" async=""></script><script src="/_next/static/chunks/pages/_app-2f6c726a4c5d3dfd1e8f.js" async=""></script><script src="/_next/static/chunks/0a3463f7b698f32fd7af40216f1292ceb318b3f7.39ce756e4870b72d4174.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-29dccdc32ec4574aab67.js" async=""></script><script src="/_next/static/kin1HMdhXCenXl5fEijbK/_buildManifest.js" async=""></script><script src="/_next/static/kin1HMdhXCenXl5fEijbK/_ssgManifest.js" async=""></script></body></html>