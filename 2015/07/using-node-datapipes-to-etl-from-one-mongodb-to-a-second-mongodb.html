<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="google-site-verification" content="-Dvab_6VGkQMicZl4INhBCLfzJs7AWMwuSpN8CmbjVA" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Using Node datapipes to ETL from one MongoDB collection to a second MongoDB collection &middot; Andy Fiedler
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/fiedler.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-3dkvEK0WLHRJ7/Csr0BZjAWxERc5WH7bdeUya2aXxdU= sha512-+L4yy6FRcDGbXJ9mPG8MT/3UCDzwR9gPeyFNMCtInsol++5m3bk2bXWKdZjvybmohrAsn3Ua5x8gfLnbE1YkOg==" crossorigin="anonymous">

  <!-- Icons -->

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- JS -->
  <script>
    // Picture element HTML5 shiv
    document.createElement( "picture" );
  </script>
  <script async src="/public/js/picturefill.min.js"></script>
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Andy Fiedler
        </a>
      </h1>
      <p class="lead"></p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            
              <a class="sidebar-nav-item" href="/projects/">Projects</a>
            
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

    </nav>

    <div class="sidebar-footer">
      <p>&copy; 2021 <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC</a>.</p>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Using Node datapipes to ETL from one MongoDB collection to a second MongoDB collection</h1>
  <span class="post-date">15 Jul 2015</span>
  <p>ETL - not the most fun to write, but the <a href="https://www.npmjs.com/package/datapipes">datapipes</a> package makes it pretty easy on NodeJS.</p>

<p>One thing that wasn’t explained in the documentation well was how to ETL from one MongoDB to another using the MongodbMixin. The problem when you use the MongodbMixin twice in the same pipe is that it gets confused about which connection to use for which things. Here’s how to use pipe groups to fix that.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">etlProcess</span> <span class="o">=</span> <span class="nx">datapumps</span><span class="p">.</span><span class="nx">group</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">extractPump</span> <span class="o">=</span> <span class="nx">etlProcess</span><span class="p">.</span><span class="nx">addPump</span><span class="p">(</span><span class="dl">'</span><span class="s1">extract</span><span class="dl">'</span><span class="p">)</span>
<span class="nx">extractPump</span>
  <span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="nx">MongodbMixin</span><span class="p">(</span><span class="nx">sourceDbUrl</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">useCollection</span><span class="p">(</span><span class="nx">sourceCollection</span><span class="p">)</span>
  <span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">extractPump</span><span class="p">.</span><span class="nx">find</span><span class="p">({}));</span> <span class="c1">// take all items from sourceCollection</span>

<span class="kd">var</span> <span class="nx">upsertPump</span> <span class="o">=</span> <span class="nx">etlProcess</span><span class="p">.</span><span class="nx">addPump</span><span class="p">(</span><span class="dl">'</span><span class="s1">upsert</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">upsertPump</span>
  <span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">extractPump</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="nx">MongodbMixin</span><span class="p">(</span><span class="nx">sinkDbUrl</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">useCollection</span><span class="p">(</span><span class="nx">sinkDbCollection</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">process</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1"> - ETLing </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">item</span><span class="p">[</span><span class="dl">'</span><span class="s1">_id</span><span class="dl">'</span><span class="p">]);</span>
    <span class="c1">// need to return a promise from process</span>
    <span class="k">return</span> <span class="nx">upsertPump</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="dl">'</span><span class="s1">_id</span><span class="dl">'</span><span class="p">:</span> <span class="nx">item</span><span class="p">[</span><span class="dl">'</span><span class="s1">_id</span><span class="dl">'</span><span class="p">]</span> <span class="p">},</span> <span class="nx">item</span><span class="p">,</span> <span class="p">{</span><span class="na">upsert</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
  <span class="p">});</span>


<span class="nx">etlProcess</span>
  <span class="p">.</span><span class="nx">logErrorsToConsole</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">start</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">whenFinished</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">finished ETLing.</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre></div></div>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/03/mac-m1-gotchas">
            Mac M1 Gotchas
            <small>02 Mar 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/06/useful-command-line-tools">
            Useful Command Line Tools
            <small>01 Jun 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2017/01/mongodb-stream-to-hapi">
            Streaming Hapi Responses with MongoDB
            <small>10 Jan 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

    
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25710888-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </body>
</html>
