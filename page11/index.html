<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="google-site-verification" content="-Dvab_6VGkQMicZl4INhBCLfzJs7AWMwuSpN8CmbjVA" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Andy Fiedler &middot; 
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/fiedler.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-3dkvEK0WLHRJ7/Csr0BZjAWxERc5WH7bdeUya2aXxdU= sha512-+L4yy6FRcDGbXJ9mPG8MT/3UCDzwR9gPeyFNMCtInsol++5m3bk2bXWKdZjvybmohrAsn3Ua5x8gfLnbE1YkOg==" crossorigin="anonymous">

  <!-- Icons -->

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- JS -->
  <script>
    // Picture element HTML5 shiv
    document.createElement( "picture" );
  </script>
  <script async src="/public/js/picturefill.min.js"></script>
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Andy Fiedler
        </a>
      </h1>
      <p class="lead"></p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
            
              <a class="sidebar-nav-item" href="/projects/">Projects</a>
            
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

    </nav>

    <div class="sidebar-footer">
      <p>&copy; 2021 <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC</a>.</p>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/08/using-nginx-to-proxy-tilestache">
        Using NGINX to proxy TileStache 
      </a>
    </h1>

    <span class="post-date">30 Aug 2012</span>

    <p>I'm working on a re-rendering of OpenStreetMap for hiking, with hill shading and topographic lines and I decided to use TileStache to render the tiles. TileStache has the nice ability to render tiles from a bunch of different sources and then overlay them with different amounts of transparency and layer masks (just like Photoshop). TileStache is a Python WSGI server that you can run in mod_python or GUnicorn to serve tiles directly over HTTP. TileStache can cache map tiles to the file system and serve the static PNGs if they exist or render them from scratch using Mapnik if they don't. Its pretty fast, especially if the tiles are pre-rendered.</p>
<p>However, GUnicorn is a pre-forking server. This means that it needs to fork a different process for each client connection. What happens if a slow client connects is that TileStache processes are rapidly used up to serve that client (typically clients make up to 8 separate HTTP connections for slippy maps, resulting in 8 processes each!). This is the case even if the tiles are being served from cache.</p>
<p>What you need to do is add a reverse proxy in front of GUnicorn, using something like NGINX. The reverse proxy using an evented IO model, which enables it to manage sending data back to a slow client without using an operating system process. NGINX can also directly serve static assets from the filesystem, which means we can serve the cached tiles without even hitting GUnicorn&#47;TileStache.</p>
<p>Getting this to work requires a bit of NGINX HttpRewriteModule voodoo, though. The issue is that TileStache saves cached tiles in a slightly different path than the URI path that comes in via HTTP. Say you have a OpenStreetMap-style URL like this: <code>myserver.com&#47;tiles&#47;layer&#47;$z&#47;$x&#47;$y.png&lt;&#47;code&gt;. In this URL, <code>$z&lt;&#47;code&gt; is zoom level (usually 1-19), and <code>$x&lt;&#47;code&gt; and <code>$y&lt;&#47;code&gt; are tile coordinates. For higher zoom levels, you can have 10,000+ by 10,0000+ tiles in the x and y directions. That's way too many PNG files to store in one folder on the filesystem. So, TileStache splits up the x and y paths into two levels. Say you have a URL like <code>&#47;tiles&#47;layer&#47;7&#47;12345&#47;67890.png&lt;&#47;code&gt;. TileStache will store that in the filesystem path <code>&#47;tiles&#47;layer&#47;7&#47;012&#47;345&#47;067&#47;890.png&lt;&#47;code&gt;. Notice how 12345 is broken into 012&#47;345? That means that there will be at most 1,000 files or folders in each directory&mdash;a manageable amount. The issue is we need to get NGINX to rewrite URLs to server these static assets. Here's how I accomplished that:&lt;/p&gt;
<pre class="lang:default highlight:0 decode:true" title="Main NGINX location directive">	location ~ ^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]+)\&#47;([\d]+)\.png {<br />
		root &#47;osm&#47;cache;&lt;/p&gt;
<p>		set $originaluri &#47;$1&#47;$2&#47;$3&#47;$4.png;</p>
<p>		# 1 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;000&#47;00$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;000&#47;0$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;000&#47;$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;00$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;0$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;00$3&#47;$4&#47;$5.png break;</p>
<p>		# 2 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;000&#47;00$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;000&#47;0$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;000&#47;$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;00$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;0$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;0$3&#47;$4&#47;$5.png break;</p>
<p>		# 3 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;000&#47;00$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;000&#47;0$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;000&#47;$4.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;00$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;0$4&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;000&#47;$3&#47;$4&#47;$5.png break;</p>
<p>		# 4 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;000&#47;00$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;000&#47;0$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;000&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;00$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;0$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{1})([\d]{3})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;00$3&#47;$4&#47;$5&#47;$6.png break;</p>
<p>		# 5 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;000&#47;00$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;000&#47;0$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;000&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;00$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;0$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{2})([\d]{3})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;0$3&#47;$4&#47;$5&#47;$6.png break;</p>
<p>		# 6 char X<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{1}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;000&#47;00$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{2}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;000&#47;0$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{3}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;000&#47;$5.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{1})([\d]{3}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;00$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{2})([\d]{3}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;0$5&#47;$6.png break;<br />
		rewrite "^\&#47;tiles\&#47;([\w\-]+)\&#47;([\d]+)\&#47;([\d]{3})([\d]{3})\&#47;([\d]{3})([\d]{3}).png$" &#47;$1&#47;$2&#47;$3&#47;$4&#47;$5&#47;$6.png break;</p>
<p>		# Try to serve the file from the disk. If that doesn't work, pass through the request via the proxy<br />
		try_files $uri @tilestache;<br />
	}&lt;&#47;pre&gt;<br />
This mountain of rewrite lines will rewrite the request URL to the filesystem format, then look for tiles in the filesystem tree starting at <code>&#47;osm&#47;cache&lt;&#47;code&gt;. The last line tells NGINX to look for the rewritten URL, then if the file is not found, to send the request to the <code>@tilestache;&lt;&#47;code&gt; location block, which looks like this:&lt;/p&gt;
<pre class="lang:default highlight:0 decode:true " title="Proxy NGINX block">	 location @tilestache {&lt;/p&gt;
<p>		# Rewrite back to standard OSM form<br />
		rewrite ^(.*)$ $originaluri break;<br />
		add_header X-Static miss;<br />
		proxy_pass http:&#47;&#47;127.0.0.1:8080;<br />
		proxy_set_header Host $http_host;<br />
	}&lt;&#47;pre&gt;<br />
That location block proxies the request to the GUnicorn server listening on localhost:8080.</p>
<p>This seems to be working great. NGINX is far faster in serving static assets, and if all of the worker TileStache processes are busy rendering, the cached zoom levels of the map work fine!</p>
</pre></code></code></p></pre></code></code></code></code></code></code></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/08/openstreetmaps-rising-popularity">
        OpenStreetMap's rising popularity
      </a>
    </h1>

    <span class="post-date">28 Aug 2012</span>

    <p><a href="http:&#47;&#47;arstechnica.com&#47;business&#47;2012&#47;08&#47;craigslist-is-on-board-openstreetmap-continues-soaring-to-new-heights&#47;">Craigslist is on board: OpenStreetMap soars to new heights&lt;&#47;a&gt;&lt;/p&gt;
<p>Craigslist is now using OpenStreetMap for showing the location of apartment listings! This is great for two reasons. First, looking for apartments will become much easier on Craigslist. Second, it's validation that OpenStreetMap's dataset is hugely valuable and robust enough for commercial use. Hopefully, I'll be rolling out my OpenStreetMap project within the next week or so. The project is a re-rendering of the basic slippy map with topographic lines and hiking trails taking more&nbsp;prominence. More to come!</p>
</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/08/backbone-js-thankfully-a-great-mvc-framework-for-the-frontend">
        Backbone.js: Thankfully, a great MVC framework for the frontend
      </a>
    </h1>

    <span class="post-date">28 Aug 2012</span>

    <h2>Frameworks, frameworks...&lt;&#47;h2&gt;<br />
On the backend, web development frameworks have been growing quickly in popularity. Rails, Django, CakePHP, and others are popular because they save developers a ton of time. Someone once said that a good developer is a lazy developer, and frameworks enable developers to kick back with a Corona on a beach (well, not quite, but close) by making a lot of the architectural decisions for the developer. Rails is a great example of this, with a clear MVC structure, preset file system&nbsp;hierarchy, and even database schema conventions. If you were coding a site in pure Ruby, you'd need to make all of these decision yourself.&lt;/p&gt;
<p>While backend frameworks are really popular, there has been a dearth of good choices in front end frameworks. As web apps are moving more processing to client-side Javascript, this was becoming a growing problem.</p>
<h2>The front-end Javascript jungle&lt;&#47;h2&gt;<br />
Front-end javascript tends to be a huge mess of jQuery callbacks, DOM elements stuffed with extra object properties, and a polluted root <code>window&lt;&#47;code&gt; object. As client-side applications are get larger, this is completely unsustainable. It makes code hard to maintain, hard to understand, and un-testable with unit testing libraries. Backbone.js greatly helps with all of these issues.&lt;/p&gt;
<h2>Enter Backbone.js&lt;&#47;h2&gt;<br />
Backbone is a minimalist MVC framework for Javascript. It adds models and collections with persistance code that works well with JSON REST APIs, as well as views that automatically re-render on model updates and controllers that handle hash-bang URLs or HTML5 <code>pushState&lt;&#47;code&gt;.&lt;/p&gt;
<p>All of this comes in 4KB of minified Javascript that ties in with jQuery, Underscore, or any other Javascript library.</p>
<h2>Backbone dos and don'ts&lt;&#47;h2&gt;<br />
I'm currently working on a small side project to brush up on some Javascript coding, and decided to use Backbone as a front-end framework (I'm using Rails on the backend). Here's some brief notes from a my first impressions:&lt;/p&gt;
<p><strong>Do&lt;&#47;strong&gt;&lt;/p&gt;
<ul>
<li>Put most of your front-end application (or business) logic in the models. This is basically the same thing you would do with a MVC app on the server.&lt;&#47;li&gt;
<li>Use a templating library. Underscore.js has a pretty decent <code>_.template()&lt;&#47;code&gt; function. HTML in really clutters your Javascript code.&lt;&#47;li&gt;
<li>Try using the Rails asset pipeline or some other way to minify and compile your JS. This way, you can spread your Backbone code out into many files. I tended to use a folder&nbsp;hierarchy&nbsp;similar to Rails (folders for models, collections, controllers, and views).&lt;&#47;li&gt;<br />
&lt;&#47;ul&gt;<br />
<strong>Don't&lt;&#47;strong&gt;&lt;/p&gt;
<ul>
<li>Put much logic in your views. It is&nbsp;<em>very&lt;&#47;em&gt;&nbsp;hard to debug view code because the function that renders the view is typically created&nbsp;programmatically&nbsp;by the templating library.&lt;&#47;li&gt;
<li>Don't prematurely optimize your view code. The easiest way to render a view is to just create an HTML fragment from a templating library then insert it into the DOM with jQuery. This is fine for most cases. You can also manipulate the DOM by changing the inner text of elements on a view re-render, which might be faster but often isn't worth the extra work.&lt;&#47;li&gt;<br />
&lt;&#47;ul&gt;&lt;/p&gt;
</li></em></li></ul></strong></li></code></li></li></ul></strong></p></h2></code></h2></code></h2></h2>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/08/using-capistrano-to-deploy-rails-apps-from-gitolite">
        Using Capistrano to deploy Rails apps from Gitolite
      </a>
    </h1>

    <span class="post-date">23 Aug 2012</span>

    <p>Here, I'll show you how to deploy a Rails app from a Gitolite repository via Capistrano. In this example, I'm running a Phusion Passenger on NGINX on Ubuntu 10.04. The instructions should be very similar for Ubuntu 12.04.</p>
<p>First, understand what we're doing here. I'm assuming you are using Gitolite for version control (although similar instructions would probably work for Github). We're going to add a read-only deployment key to the Gitolite repository. When you run <code>cap deploy&lt;&#47;code&gt;, Capistrano will log into your production server via SSH (using public key authentication). Then the Capistrano script will instruct the production server to check out the latest version of your app from the Gitolite repository into a directory on the production server. Finally, the Capistrano script will change a symlink to the new version of your app and instruction Phusion Passenger to reload the app into memory on the next hit.&lt;/p&gt;
<h2>Setting up your production server&lt;&#47;h2&gt;<br />
Create a new user for deployment-related tasks on your production server. Switch to that user.&lt;/p&gt;
<pre class="lang:sh">sudo adduser deployuser<br />
sudo su - deployuser&lt;&#47;pre&gt;<br />
Now, generate some SSH keys for that user. Run as the deployuser:&lt;/p&gt;
<pre class="lang:sh">ssh-keygen -t rsa&lt;&#47;pre&gt;<br />
I don't typically enter a password for this keypair. The reason is that this keypair is only used for read-only access to your code repository in Gitolite. If your code is highly sensitive, you might want a password. If you enter one here, you will be prompted for it each time you deploy code.&lt;/p&gt;
<p>Now, wherever you have your Gitolite admin repository checked out, open it up and add the public key to your keydir folder. I like to keep my deployment keys in a subfolder called something like "deployment".</p>
<p>Say, for example, your Gitolite admin repository is at <code>~&#47;repos&#47;gitolite-admin&lt;&#47;code&gt;. Switch to that path. Now enter the folder <code>keydir&lt;&#47;code&gt;. Make a new subfolder called <code>deployment&lt;&#47;code&gt;, and then a new file in that folder called something like <code>MyDeploymentKey.pub&lt;&#47;code&gt;. Open that file in your editor and paste the public key that you just created from your deployment server. Typically, that key is found at <code>~&#47;.ssh&#47;id_rsa.pub&lt;&#47;code&gt;.&lt;/p&gt;
<p>Now, open your <code>gitolite.conf&lt;&#47;code&gt; file (in the <code>conf&lt;&#47;code&gt; folder in your Gitolite repository). Find your project and add a directive to grant your deployment key read-only access. Here's an example project section:&lt;/p&gt;
<pre class="lang:default highlight:0 decode:true crayon-selected">repo     my-project<br />
         RW = JoeCoder<br />
         R = MyDeploymentKey&lt;&#47;pre&gt;<br />
Note that even though the deployment key could be in a subfolder, you still just enter the filename minus the ".pub".&lt;/p&gt;
<p>Save the Gitolite files, commit and push to your Gitolite server.</p>
<h2>Setting up Capistrano&lt;&#47;h2&gt;<br />
Now, open up your Rails project you want to deploy. Add these gems:&lt;/p&gt;
<pre class="lang:ruby"># Gems for deployment<br />
group :development do<br />
  gem "capistrano"<br />
  gem 'rvm-capistrano'<br />
end&lt;&#47;pre&gt;<br />
Run <code>bundle install&lt;&#47;code&gt; and then from the top directory of your project, run <code>capify .&lt;&#47;code&gt;. This adds Capistrano to your project. Open up <code>config&#47;deploy.rd&lt;&#47;code&gt; and add something like this:&lt;/p&gt;
<pre class="lang:ruby">require "bundler&#47;capistrano"<br />
require "rvm&#47;capistrano"&lt;/p&gt;
<p>set :application,   "myapp"<br />
set :domain,        "mydomain.com"<br />
set :repository,    "git@mygitoliteserver.com:mygitrepo"<br />
set :use_sudo,      false<br />
set :deploy_to,     "&#47;srv&#47;mydomain.com&#47;public&#47;#{application}"<br />
set :scm,           "git"<br />
set :user,          "deployuser"</p>
<p>role :app, domain<br />
role :web, domain<br />
role :db, domain, :primary =&gt; true</p>
<p># Add RVM's lib directory to the load path.<br />
set :rvm_ruby_string, 'ruby-1.9.3-p358'<br />
set :rvm_type, :system</p>
<p>namespace :deploy do<br />
  task :start, :roles =&gt; :app do<br />
    run "touch #{current_release}&#47;tmp&#47;restart.txt"<br />
  end</p>
<p>  task :stop, :roles =&gt; :app do<br />
    # Do nothing.<br />
  end</p>
<p>  desc "Restart Application"<br />
  task :restart, :roles =&gt; :app do<br />
    run "touch #{current_release}&#47;tmp&#47;restart.txt"<br />
  end</p>
<p>end&lt;&#47;pre&gt;<br />
This deploy script will checkout your code from the project myproject on mygitoliteserver.com and deploy it to <code>&#47;srv&#47;mydomain.com&#47;public&lt;&#47;code&gt; on your production server (make sure you create this directory). Whenever you deploy, Capistrano will touch <code>tmp&#47;restart.txt&lt;&#47;code&gt; so that Phusion Passenger restarts with the new code.&lt;/p&gt;
<p>Once you are finished editing this script, commit your changes, push your latest code to your Gitolite server.</p>
<h2>Deciding who gets to deploy&lt;&#47;h2&gt;<br />
For each user you want to allow to deploy code, have them generate a SSH key. On your deployment server, open or create <code>~deployuser&#47;.ssh&#47;authorized_keys&lt;&#47;code&gt;. For each user you want to allow to deploy, add their public key (one key per line) to this file.&lt;/p&gt;
<h2>Deploying!&lt;&#47;h2&gt;<br />
Now, to test out deployment, run from your Rails root on your development machine (the machine that has the SSH key you added to <code>~deployuser&#47;.ssh&#47;authorized_keys&lt;&#47;code&gt;), run <code>cap deploy&lt;&#47;code&gt;.&lt;/p&gt;
</code></code></h2></code></h2></code></code></p></pre></code></code></code></pre></h2></pre></code></code></p></code></code></code></code></code></p></pre></pre></h2></code></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/08/5-government-datasets-for-building-web-apps">
        5 Government datasets for building web apps
      </a>
    </h1>

    <span class="post-date">08 Aug 2012</span>

    <p>Recently, I've gotten interested in using some open government data to build useful web applications. There has been a bit of work in this space, with many Federal agencies sponsoring app contests for developers to create products that show off the agencies' datasets.<a title="U.S. Government Apps Challenge" href="http:&#47;&#47;challenge.gov"> Challenge.gov&lt;&#47;a&gt; is the central listing of these app contests; take a look if you are interested in seeing what kind of challenges are open for entries. I've had a bit of experience working with government data and here's some of the most interesting datasets that I've found so far.&lt;/p&gt;
<h3><a href="http:&#47;&#47;www.census.gov&#47;geo&#47;www&#47;tiger&#47;">U.S. Census TIGER&lt;&#47;a&gt;&lt;&#47;h3&gt;<br />
This is the mother of all mapping datasets in the U.S. It contains most roads, populated places, and administrative boundaries (for counties and states). There is also a ton of demographic data available subset by geographic location. These are huge datasets, and would need specialized GIS knowledge to do much with. The OpenStreetMap project has imported most of the roads and administrative boundary data, making the U.S. portion of their map pretty detailed. One issue with TIGER data is that many of the roads in the dataset no longer exist. This is especially true in areas that have lost population, like abandoned towns or areas converted to national parks.&lt;/p&gt;
<h3><a href="http:&#47;&#47;research.stlouisfed.org&#47;fred2&#47;">Federal Reserve Economic Data (FRED)&lt;&#47;a&gt;&lt;&#47;h3&gt;<br />
Almost any conceivable economic indicator for the U.S., going back as far as government data exists. Want to know the USD&#47;GBP exchange rate in 1974? Got it. CPI for 1951? No problem. There are also a lot of useful graphing tools built into the site and a nice REST API for accessing the data from web services.&lt;/p&gt;
<h3><a href="http:&#47;&#47;www.ncdc.noaa.gov&#47;nexradinv&#47;chooseday.jsp?id=klsx">NOAA Weather Radars&lt;&#47;a&gt;&lt;&#47;h3&gt;<br />
Historical RADARs back to the 1990s and near real-time radar images (10 minute or so delay). This website also has satellite images back to the 1970s. I'm sure there is some kind of really cool big data project you could create with these. Maybe show the historical&nbsp;likelihood&nbsp;of rain in a particular location on a particular day of the year, or check historical satellite images to determine when is the best change for a sunny day.&lt;/p&gt;
<h3><a href="http:&#47;&#47;www.sec.gov&#47;edgar.shtml">Securities and Exchange&nbsp;Commission&nbsp;EDGAR&lt;&#47;a&gt;&lt;&#47;h3&gt;<br />
Near real-time display of all filings for&nbsp;publicly-traded companies in the U.S. New share&nbsp;issuance,&nbsp;&nbsp;corporate governance changes, and quarterly reports are all there.&lt;/p&gt;
<h3><a href="http:&#47;&#47;waterdata.usgs.gov&#47;nwis">USGS Stream Flow&lt;&#47;a&gt;&lt;&#47;h3&gt;<br />
I'm mostly putting this on here because I check it frequently for kayaking. This site has near real-time data on the flow and temperature of many rivers in the U.S. The data comes from gauging stations operated by USGS.&lt;/p&gt;
<p>&nbsp;</p>
</a></h3></a></h3></a></h3></a></h3></a></h3></a></p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page12">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page10">Newer</a>
    
  
</div>
    </div>

    
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25710888-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </body>
</html>
