{"pageProps":{"postData":{"id":"querying-inside-postgres-json-arrays","contentHtml":"<p>Postgres JSON support is pretty amazing. I've been using it extensively for storing semi-structured data for a project and it has been great for that use case. In Postgres 9.3, the maintainers added the ability to perform some simple queries on JSON structures and a few functions to convert from JSON to Postgres arrays and result sets.</p>\n<p>One feature that I couldn't figure out how to implement using the built-in Postgres functions was the ability to query within a JSON array. This is fairly critical for lots of the reporting queries that I've been building over the part few days. Suppose you have some JSON like this, stored in two rows in a table called \"orders\", in the column \"json_field\":</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Row 1, \"json_field\" column -----</span>\n<span class=\"token punctuation\">{</span>\n   <span class=\"token string\">\"products\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span> <span class=\"token string\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Fish Tank\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> <span class=\"token string\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Bird Feeder\"</span> <span class=\"token punctuation\">}</span>\n   <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Row 2, \"json_field\" column -----</span>\n<span class=\"token punctuation\">{</span>\n   <span class=\"token string\">\"products\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span> <span class=\"token string\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Bird Feeder\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> <span class=\"token string\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Cat Pole\"</span> <span class=\"token punctuation\">}</span>\n   <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>If you want to run a query like \"find all distinct IDs in the json_field's products array\", you can't do that with the built in JSON functions that Postgres currently supplies (as far as I'm aware!). This is a fairly common use case, especially for reporting.</p>\n<p>To get this work, I wrote this simple PgPL/SQL function to map a JSON array.</p>\n<div class=\"remark-highlight\"><pre class=\"language-pgpsql\"><code class=\"language-pgpsql\">CREATE OR REPLACE FUNCTION json_array_map(json_arr json, path TEXT[]) RETURNS json[]\nLANGUAGE plpgsql IMMUTABLE AS $$\nDECLARE\n\trec json;\n\tlen int;\n\tret json[];\nBEGIN\n\t-- If json_arr is not an array, return an empty array as the result\n\tBEGIN\n\t\tlen := json_array_length(json_arr);\n\tEXCEPTION\n\t\tWHEN OTHERS THEN\n\t\t\tRETURN ret;\n\tEND;\n\n\t-- Apply mapping in a loop\n\tFOR rec IN SELECT json_array_elements#&#x26;gt;path FROM json_array_elements(json_arr)\n\tLOOP\n\t\tret := array_append(ret,rec);\n\tEND LOOP;\n\tRETURN ret;\nEND $$;</code></pre></div>\n<p>What this function does is given a JSON array as \"json_arr\" and a JSON path as \"path\", it will loop through all elements of the JSON array, locate the element at the path, and store it in a Postgres native array of JSON elements. You can then use other Postgres array functions to aggregate it.</p>\n<p>For the query above where we want to find distinct product IDs in the orders table, we could write something like this:</p>\n<div class=\"remark-highlight\"><pre class=\"language-pgpsql\"><code class=\"language-pgpsql\">SELECT DISTINCT unnest(json_array_map(orders.json_field#&#x26;gt;&#x26;#39;{products}&#x26;#39;, &#x26;#39;{id}&#x26;#39;::text[]))::text AS &#x26;quot;id&#x26;quot; FROM orders;</code></pre></div>\n<p>That would give you the result:</p>\n<h2><pre> id</h2>\n<p> 2\n3\n1</pre>\nPretty cool!</p>\n","layout":"post","status":"publish","published":true,"title":"Querying Inside Postgres JSON Arrays","author":{"display_name":"afiedler","login":"afiedler","email":"andy@andyfiedler.com","url":""},"author_login":"afiedler","author_email":"andy@andyfiedler.com","wordpress_id":260,"wordpress_url":"http://andyfiedler.com/?p=260","date":"2014-03-14 12:17:58 -0400","date_gmt":"2014-03-14 16:17:58 -0400","categories":["Tech Notes"],"tags":[],"redirect_from":["/blog/querying-inside-postgres-json-arrays-260/","/blog/querying-inside-postgres-json-arrays-260"]}},"__N_SSG":true}