{"pageProps":{"postData":{"id":"using-node-datapipes-to-etl-from-one-mongodb-to-a-second-mongodb","contentHtml":"<p>ETL - not the most fun to write, but the datapipes package makes it pretty easy on NodeJS.</p>\n<p>One thing that wasn't explained in the documentation well was how to ETL from one MongoDB to another using the MongodbMixin. The problem when you use the MongodbMixin twice in the same pipe is that it gets confused about which connection to use for which things. Here's how to use pipe groups to fix that.</p>\n<div><pre><code><span>var</span> etlProcess <span>=</span> datapumps<span>.</span><span>group</span><span>(</span><span>)</span><span>;</span>\n\n<span>var</span> extractPump <span>=</span> etlProcess<span>.</span><span>addPump</span><span>(</span><span>'extract'</span><span>)</span>\nextractPump\n  <span>.</span><span>mixin</span><span>(</span><span><span>MongodbMixin</span></span><span>(</span>sourceDbUrl<span>)</span><span>)</span>\n  <span>.</span><span>useCollection</span><span>(</span>sourceCollection<span>)</span>\n  <span>.</span><span>from</span><span>(</span>extractPump<span>.</span><span>find</span><span>(</span><span>{</span><span>}</span><span>)</span><span>)</span><span>;</span> <span>// take all items from sourceCollection</span>\n\n<span>var</span> upsertPump <span>=</span> etlProcess<span>.</span><span>addPump</span><span>(</span><span>'upsert'</span><span>)</span><span>;</span>\nupsertPump\n  <span>.</span><span>from</span><span>(</span>extractPump<span>)</span>\n  <span>.</span><span>mixin</span><span>(</span><span><span>MongodbMixin</span></span><span>(</span>sinkDbUrl<span>)</span><span>)</span>\n  <span>.</span><span>useCollection</span><span>(</span>sinkDbCollection<span>)</span>\n  <span>.</span><span>process</span><span>(</span><span>function</span><span>(</span><span>item</span><span>)</span> <span>{</span>\n    <span>console</span><span>.</span><span>log</span><span>(</span><span>' - ETLing '</span> <span>+</span> item<span>[</span><span>'_id'</span><span>]</span><span>)</span><span>;</span>\n    <span>// need to return a promise from process</span>\n    <span>return</span> upsertPump<span>.</span><span>update</span><span>(</span><span>{</span> <span>'_id'</span><span>:</span> item<span>[</span><span>'_id'</span><span>]</span> <span>}</span><span>,</span> item<span>,</span> <span>{</span>upsert<span>:</span> <span>true</span><span>}</span><span>)</span><span>;</span>\n  <span>}</span><span>)</span><span>;</span>\n\n\netlProcess\n  <span>.</span><span>logErrorsToConsole</span><span>(</span><span>)</span>\n  <span>.</span><span>start</span><span>(</span><span>)</span>\n  <span>.</span><span>whenFinished</span><span>(</span><span>)</span><span>.</span><span>then</span><span>(</span><span>function</span><span>(</span><span>)</span> <span>{</span>\n    <span>console</span><span>.</span><span>log</span><span>(</span><span>'finished ETLing.'</span><span>)</span><span>;</span>\n    process<span>.</span><span>exit</span><span>(</span><span>0</span><span>)</span><span>;</span>\n  <span>}</span><span>)</span><span>;</span>\n</code></pre></div>\n","layout":"post","status":"publish","published":true,"title":"Using Node datapipes to ETL from one MongoDB collection to a second MongoDB collection","author":{"display_name":"afiedler","login":"afiedler","email":"andy@andyfiedler.com","url":""},"author_login":"afiedler","author_email":"andy@andyfiedler.com","wordpress_id":321,"wordpress_url":"http://andyfiedler.com/?p=321","date":"2015-07-15 16:14:01 -0400","date_gmt":"2015-07-15 20:14:01 -0400","categories":["Scrapbook"],"tags":["nodejs","mongodb","data"]}},"__N_SSG":true}